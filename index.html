<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€»è¾‘æ¼”æ­¦åœº Â· AI é€»è¾‘å£æ‰ç‰¹è®­</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink: '#0f172a',      // èƒŒæ™¯ 60%
            aurora: '#10b981',   // ä¸»å“ç‰Œ 30%
            gold: '#f59e0b',     // å¼ºè°ƒ 10%
            title: '#f8fafc',
            body: '#cbd5e1',
            muted: '#64748b'
          },
          boxShadow: {
            glow: '0 0 0 1px rgba(16,185,129,.18), 0 18px 50px rgba(16,185,129,.15)',
            gold: '0 0 0 1px rgba(245,158,11,.18), 0 18px 50px rgba(245,158,11,.12)'
          }
        }
      }
    }
  </script>

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- FontAwesome (CDN) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Animate.css (CDN) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

  <!-- Marked.js (CDN) - Markdown æ¸²æŸ“ï¼ˆç‚¹è¯„ä¸º Markdownï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>

  <style>
    :root { color-scheme: dark; }
    body { background: #0f172a; }

    /* ç»†è…»çš„éª¨æ¶å± shimmerï¼ˆæ‹’ç»å•çº¯è½¬åœˆï¼‰ */
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .skeleton {
      background: linear-gradient(90deg, rgba(100,116,139,.15) 25%, rgba(203,213,225,.15) 37%, rgba(100,116,139,.15) 63%);
      background-size: 400% 100%;
      animation: shimmer 1.2s ease-in-out infinite;
      border-radius: 0.75rem;
    }

    /* å½•éŸ³å£°æ³¢çº¹æ‰©æ•£ */
    @keyframes pulseRing {
      0% { transform: translate(-50%, -50%) scale(0.65); opacity: .75; }
      100% { transform: translate(-50%, -50%) scale(1.35); opacity: 0; }
    }
    .pulse-wrap { position: relative; }
    .pulse-wrap[data-on="true"]::before,
    .pulse-wrap[data-on="true"]::after {
      content: '';
      position: absolute;
      left: 50%;
      top: 50%;
      width: 120%;
      height: 120%;
      border-radius: 9999px;
      background: rgba(16,185,129,.18);
      border: 1px solid rgba(16,185,129,.35);
      transform: translate(-50%, -50%);
      animation: pulseRing 1.25s cubic-bezier(.2,.6,.2,1) infinite;
      pointer-events: none;
    }
    .pulse-wrap[data-on="true"]::after { animation-delay: .4s; }

    /* CTA å…‰æ•ˆ */
    @keyframes sheen {
      0% { transform: translateX(-120%) skewX(-18deg); opacity: 0; }
      35% { opacity: .85; }
      100% { transform: translateX(220%) skewX(-18deg); opacity: 0; }
    }
    .sheen {
      position: relative;
      overflow: hidden;
    }
    .sheen::after {
      content: '';
      position: absolute;
      inset: -40% auto -40% -30%;
      width: 40%;
      background: linear-gradient(90deg, transparent, rgba(248,250,252,.35), transparent);
      transform: translateX(-120%) skewX(-18deg);
      animation: sheen 2.8s ease-in-out infinite;
    }

    /* è§†å›¾æ˜¾ç¤º */
    .view { display: none; }
    .view.active { display: block; }

    /* æ‰‹é£ç´è¿‡æ¸¡ */
    .accordion {
      max-height: 0;
      overflow: hidden;
      transition: max-height .28s ease;
    }
    .accordion.open { max-height: 1200px; }
  </style>
</head>
<body class="min-h-screen bg-ink text-body">
  <!-- Toast -->
  <div id="toastHost" class="fixed top-4 right-4 z-[1000] flex flex-col gap-3 w-[min(22rem,calc(100vw-2rem))]" aria-live="polite" aria-atomic="true"></div>

  <!-- Confirm Modal -->
  <div id="confirmOverlay" class="fixed inset-0 z-[999] hidden" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative mx-auto mt-24 w-[min(34rem,calc(100vw-2rem))] rounded-2xl border border-slate-700/60 bg-slate-900/80 backdrop-blur p-6 shadow-xl animate__animated animate__fadeIn">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div id="confirmTitle" class="text-title text-xl font-bold">äºŒæ¬¡ç¡®è®¤</div>
          <div id="confirmDesc" class="mt-2 text-sm text-body leading-relaxed"></div>
        </div>
        <button id="confirmClose" class="text-muted hover:text-title transition" aria-label="å…³é—­å¼¹çª—">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </div>
      <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-end">
        <button id="confirmCancel" class="px-4 py-2 rounded-xl border border-slate-700/70 bg-slate-900/60 text-body hover:bg-slate-800/60 hover:-translate-y-0.5 active:scale-95 transition" aria-label="å–æ¶ˆ">
          å–æ¶ˆ
        </button>
        <button id="confirmOk" class="px-4 py-2 rounded-xl border border-red-500/40 bg-red-500/10 text-red-200 hover:bg-red-500/15 hover:-translate-y-0.5 active:scale-95 transition" aria-label="ç¡®è®¤">
          ç¡®è®¤æ¸…é™¤
        </button>
      </div>
    </div>
  </div>

  <!-- Navbar -->
  <header class="sticky top-0 z-50 border-b border-slate-700/50 bg-ink/75 backdrop-blur">
    <nav class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between gap-4">
      <button id="brandBtn" class="flex items-center gap-3 group" aria-label="è¿”å›é¦–é¡µ">
        <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-aurora/25 via-aurora/10 to-gold/20 border border-slate-700/50 flex items-center justify-center shadow-glow">
          <i class="fa-solid fa-chess-knight text-aurora"></i>
        </div>
        <div class="text-left leading-tight">
          <div class="text-title font-extrabold tracking-wide">é€»è¾‘æ¼”æ­¦åœº</div>
          <div class="text-xs text-muted">AI é€»è¾‘å£æ‰ç‰¹è®­ Â· SPA</div>
        </div>
      </button>

      <!-- Desktop -->
      <div class="hidden md:flex items-center gap-2">
        <button class="navBtn px-4 py-2 rounded-xl text-sm border border-transparent hover:border-slate-700/70 hover:bg-slate-900/40 hover:-translate-y-0.5 active:scale-95 transition"
          data-route="home" aria-label="å‰å¾€é¦–é¡µ">
          <i class="fa-solid fa-house mr-2 text-muted"></i>é¦–é¡µ
        </button>
        <button class="navBtn px-4 py-2 rounded-xl text-sm border border-transparent hover:border-slate-700/70 hover:bg-slate-900/40 hover:-translate-y-0.5 active:scale-95 transition"
          data-route="history" aria-label="å‰å¾€å†å²">
          <i class="fa-solid fa-clock-rotate-left mr-2 text-muted"></i>å†å²
        </button>
        <button class="navBtn px-4 py-2 rounded-xl text-sm border border-transparent hover:border-slate-700/70 hover:bg-slate-900/40 hover:-translate-y-0.5 active:scale-95 transition"
          data-route="settings" aria-label="å‰å¾€è®¾ç½®">
          <i class="fa-solid fa-gear mr-2 text-muted"></i>è®¾ç½®
        </button>
      </div>

      <!-- Mobile -->
      <button id="menuBtn" class="md:hidden h-10 w-10 rounded-xl border border-slate-700/60 bg-slate-900/40 text-title hover:bg-slate-900/60 hover:-translate-y-0.5 active:scale-95 transition"
        aria-label="æ‰“å¼€èœå•">
        <i class="fa-solid fa-bars"></i>
      </button>
    </nav>
  </header>

  <!-- Mobile Drawer -->
  <div id="drawerOverlay" class="fixed inset-0 z-[900] hidden">
    <div class="absolute inset-0 bg-black/60"></div>
    <aside id="drawer" class="absolute right-0 top-0 h-full w-[min(20rem,80vw)] bg-slate-900/85 backdrop-blur border-l border-slate-700/60 p-4 animate__animated animate__fadeInRight">
      <div class="flex items-center justify-between">
        <div class="text-title font-bold">å¯¼èˆª</div>
        <button id="drawerClose" class="h-10 w-10 rounded-xl border border-slate-700/60 bg-slate-900/40 hover:bg-slate-900/60 hover:-translate-y-0.5 active:scale-95 transition"
          aria-label="å…³é—­èœå•">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="mt-4 flex flex-col gap-2">
        <button class="navBtn w-full text-left px-4 py-3 rounded-xl border border-slate-700/50 bg-slate-900/40 hover:bg-slate-800/50 hover:-translate-y-0.5 active:scale-95 transition"
          data-route="home" aria-label="å‰å¾€é¦–é¡µï¼ˆç§»åŠ¨ç«¯ï¼‰">
          <i class="fa-solid fa-house mr-2 text-muted"></i>é¦–é¡µ
        </button>
        <button class="navBtn w-full text-left px-4 py-3 rounded-xl border border-slate-700/50 bg-slate-900/40 hover:bg-slate-800/50 hover:-translate-y-0.5 active:scale-95 transition"
          data-route="history" aria-label="å‰å¾€å†å²ï¼ˆç§»åŠ¨ç«¯ï¼‰">
          <i class="fa-solid fa-clock-rotate-left mr-2 text-muted"></i>å†å²
        </button>
        <button class="navBtn w-full text-left px-4 py-3 rounded-xl border border-slate-700/50 bg-slate-900/40 hover:bg-slate-800/50 hover:-translate-y-0.5 active:scale-95 transition"
          data-route="settings" aria-label="å‰å¾€è®¾ç½®ï¼ˆç§»åŠ¨ç«¯ï¼‰">
          <i class="fa-solid fa-gear mr-2 text-muted"></i>è®¾ç½®
        </button>
      </div>
      <div class="mt-6 rounded-xl border border-slate-700/50 bg-slate-900/35 p-4">
        <div class="text-sm text-title font-semibold">å°æç¤º</div>
        <div class="mt-2 text-sm text-body leading-relaxed">
          è‹¥æœªé…ç½® Keyï¼Œè®­ç»ƒæµä¼šè‡ªåŠ¨æç¤ºä½ å»è®¾ç½®é¡µã€‚
        </div>
      </div>
    </aside>
  </div>

  <!-- App -->
  <main class="mx-auto max-w-6xl px-4 py-8">
    <!-- HomeView -->
    <section id="homeView" class="view active">
      <!-- Hero -->
      <div class="rounded-3xl border border-slate-700/60 bg-slate-900/35 p-8 md:p-10 shadow-glow">
        <div class="flex flex-col gap-8 md:gap-10">
          <div>
            <h1 class="text-title text-4xl md:text-4xl font-extrabold tracking-tight">
              ç”¨ AI é‡å¡‘ä½ çš„è¡¨è¾¾é€»è¾‘
            </h1>
            <p class="mt-3 text-base leading-relaxed text-body">
              å³å…´æ¼”è®² Â· é€»è¾‘è¾©è®º Â· æ·±åº¦å¤ç›˜
            </p>
            <div class="mt-6 flex flex-col sm:flex-row gap-3">
              <button id="startTrainingBtn" class="sheen px-7 py-4 rounded-2xl font-bold text-ink bg-gradient-to-r from-aurora via-aurora/90 to-gold shadow-glow hover:-translate-y-0.5 active:scale-95 transition"
                aria-label="å¼€å§‹ç‰¹è®­">
                <i class="fa-solid fa-bolt mr-2"></i>å¼€å§‹ç‰¹è®­
              </button>
              <button id="goSettingsFromHero" class="px-7 py-4 rounded-2xl font-semibold border border-slate-700/70 bg-slate-900/40 text-title hover:bg-slate-800/50 hover:-translate-y-0.5 active:scale-95 transition"
                aria-label="å‰å¾€è®¾ç½®">
                <i class="fa-solid fa-key mr-2 text-muted"></i>è®¾ç½® API Key
              </button>
            </div>
          </div>

          <!-- Rank + Stats -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="md:col-span-1 rounded-2xl border border-slate-700/60 bg-slate-900/30 p-6">
              <div class="text-sm text-muted">å½“å‰æ®µä½</div>
              <div id="rankText" class="mt-2 text-3xl font-extrabold text-title">é€»è¾‘èŒæ–°</div>
              <div class="mt-3 inline-flex items-center gap-2 text-xs text-gold">
                <i class="fa-solid fa-medal"></i><span>æŒç»­è®­ç»ƒè§£é”æ›´é«˜æ®µä½</span>
              </div>
            </div>
            <div class="rounded-2xl border border-slate-700/60 bg-slate-900/30 p-6">
              <div class="text-sm text-muted">ç´¯è®¡ç»ƒä¹ æ¬¡æ•°</div>
              <div id="statTotalCount" class="mt-2 text-3xl font-extrabold text-aurora">0</div>
            </div>
            <div class="rounded-2xl border border-slate-700/60 bg-slate-900/30 p-6">
              <div class="text-sm text-muted">ä»Šæ—¥æ—¶é•¿</div>
              <div id="statTodayMinutes" class="mt-2 text-3xl font-extrabold text-title">0 åˆ†é’Ÿ</div>
            </div>
            <div class="rounded-2xl border border-slate-700/60 bg-slate-900/30 p-6">
              <div class="text-sm text-muted">å¹³å‡å¾—åˆ†</div>
              <div id="statAvgScore" class="mt-2 text-3xl font-extrabold text-title">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <footer class="mt-10 py-8 text-center">
        <div class="text-sm text-slate-400 flex flex-col sm:flex-row items-center justify-center gap-4">
          <div class="inline-flex items-center gap-2">
            <i class="fa-solid fa-envelope text-muted"></i>
            <span>2499787198@QQ.com</span>
          </div>
          <div class="inline-flex items-center gap-2">
            <i class="fa-brands fa-weixin text-muted"></i>
            <span>y-paloma</span>
          </div>
          <div class="inline-flex items-center gap-2">
            <i class="fa-solid fa-phone text-muted"></i>
            <span>18292021906</span>
          </div>
        </div>
      </footer>
    </section>

    <!-- SettingsView -->
    <section id="settingsView" class="view">
      <div class="flex items-center justify-between gap-4">
        <button id="backHomeFromSettings" class="px-4 py-2 rounded-xl border border-slate-700/70 bg-slate-900/40 text-title hover:bg-slate-800/50 hover:-translate-y-0.5 active:scale-95 transition"
          aria-label="è¿”å›é¦–é¡µ">
          <i class="fa-solid fa-arrow-left mr-2"></i>è¿”å›é¦–é¡µ
        </button>
      </div>

      <div class="mt-6 rounded-3xl border border-slate-700/60 bg-slate-900/35 p-6 md:p-8">
        <h2 class="text-title text-3xl font-bold">è®¾ç½®</h2>
        <p class="mt-2 text-base leading-relaxed text-body">
          ä½ çš„ Key ä»…å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ï¼ˆLocalStorageï¼‰ï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•ç¬¬ä¸‰æ–¹æœåŠ¡å™¨ã€‚
        </p>

        <!-- API Key -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
          <div class="md:col-span-2">
            <label for="apiKeyInput" class="block text-sm font-semibold text-title">API Key ç®¡ç†</label>
            <div class="mt-2 relative">
              <input id="apiKeyInput" type="password" autocomplete="off"
                class="w-full rounded-2xl border border-slate-700/70 bg-slate-950/30 px-4 py-3 text-title placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-aurora/40"
                placeholder="sk-..." aria-label="è¾“å…¥ DeepSeek API Key" />
              <button id="toggleKeyVisibility" class="absolute right-3 top-1/2 -translate-y-1/2 text-muted hover:text-title transition"
                aria-label="æ˜¾ç¤ºæˆ–éšè— Key">
                <i class="fa-regular fa-eye"></i>
              </button>
            </div>
            <div class="mt-2 text-xs text-muted">
              å·²ä¿å­˜ï¼š<span id="maskedKey" class="text-body">æœªè®¾ç½®</span>
            </div>
          </div>
          <div class="md:col-span-1">
            <button id="saveKeyBtn" class="w-full px-5 py-3 rounded-2xl font-bold bg-aurora text-ink shadow-glow hover:-translate-y-0.5 active:scale-95 transition"
              aria-label="ä¿å­˜ API Key">
              <i class="fa-solid fa-floppy-disk mr-2"></i>ä¿å­˜
            </button>
          </div>
        </div>

        <!-- Data -->
        <div class="mt-10 rounded-2xl border border-slate-700/60 bg-slate-900/30 p-6">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-title font-bold">æ•°æ®ç®¡ç†</div>
              <div class="mt-1 text-sm text-body leading-relaxed">
                æ¸…é™¤åå°†åˆ é™¤æ‰€æœ‰è®­ç»ƒå†å²ä¸ç»Ÿè®¡æ•°æ®ï¼ˆä¸å¯æ¢å¤ï¼‰ã€‚
              </div>
            </div>
            <button id="clearHistoryBtn" class="px-4 py-2 rounded-xl border border-red-500/50 bg-red-500/10 text-red-200 hover:bg-red-500/15 hover:-translate-y-0.5 active:scale-95 transition"
              aria-label="æ¸…é™¤å†å²è®°å½•">
              <i class="fa-solid fa-trash mr-2"></i>æ¸…é™¤å†å²è®°å½•
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- HistoryView -->
    <section id="historyView" class="view">
      <div class="flex items-center justify-between gap-4">
        <h2 class="text-title text-3xl font-bold">å†å²</h2>
        <button id="backHomeFromHistory" class="px-4 py-2 rounded-xl border border-slate-700/70 bg-slate-900/40 text-title hover:bg-slate-800/50 hover:-translate-y-0.5 active:scale-95 transition"
          aria-label="è¿”å›é¦–é¡µ">
          <i class="fa-solid fa-arrow-left mr-2"></i>è¿”å›
        </button>
      </div>

      <div id="historyEmpty" class="mt-8 rounded-3xl border border-slate-700/60 bg-slate-900/25 p-10 text-center">
        <div class="text-gold text-4xl"><i class="fa-solid fa-scroll"></i></div>
        <div class="mt-3 text-title font-bold">æš‚æ— å†å²è®°å½•</div>
        <div class="mt-2 text-sm text-muted">å®Œæˆä¸€æ¬¡æµ‹è¯„åä¼šè‡ªåŠ¨ä¿å­˜åˆ°è¿™é‡Œã€‚</div>
      </div>

      <div id="historyGrid" class="mt-8 hidden grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </section>

    <!-- TrainingFlow -->
    <section id="trainingView" class="view">
      <!-- Breadcrumbs -->
      <div class="rounded-3xl border border-slate-700/60 bg-slate-900/25 p-5 md:p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <div class="text-title font-bold">è®­ç»ƒæµ</div>
            <div class="text-sm text-muted">é€‰é¢˜ â†’ ç­–ç•¥ â†’ æ¼”ç»ƒ â†’ æŠ¥å‘Š</div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="crumb px-3 py-2 rounded-xl text-sm border border-slate-700/60 bg-slate-900/40 hover:bg-slate-800/50 hover:-translate-y-0.5 active:scale-95 transition"
              data-step="1" aria-label="å‰å¾€é€‰é¢˜æ­¥éª¤">é€‰é¢˜</button>
            <button class="crumb px-3 py-2 rounded-xl text-sm border border-slate-700/60 bg-slate-900/40 hover:bg-slate-800/50 hover:-translate-y-0.5 active:scale-95 transition"
              data-step="2" aria-label="å‰å¾€ç­–ç•¥æ­¥éª¤">ç­–ç•¥</button>
            <button class="crumb px-3 py-2 rounded-xl text-sm border border-slate-700/60 bg-slate-900/40 hover:bg-slate-800/50 hover:-translate-y-0.5 active:scale-95 transition"
              data-step="3" aria-label="å‰å¾€æ¼”ç»ƒæ­¥éª¤">æ¼”ç»ƒ</button>
            <button class="crumb px-3 py-2 rounded-xl text-sm border border-slate-700/60 bg-slate-900/40 hover:bg-slate-800/50 hover:-translate-y-0.5 active:scale-95 transition"
              data-step="4" aria-label="å‰å¾€æŠ¥å‘Šæ­¥éª¤">æŠ¥å‘Š</button>
          </div>
        </div>

        <div class="mt-5 h-2 rounded-full bg-slate-800/60 overflow-hidden">
          <div id="progressBar" class="h-full w-1/4 bg-gradient-to-r from-aurora to-gold transition-all"></div>
        </div>
      </div>

      <!-- Alert (API error friendly) -->
      <div id="apiAlert" class="hidden mt-6 rounded-2xl border border-red-500/40 bg-red-500/10 p-4 text-red-200">
        <div class="font-bold"><i class="fa-solid fa-triangle-exclamation mr-2"></i>è¯·æ±‚å¤±è´¥</div>
        <div id="apiAlertText" class="mt-2 text-sm leading-relaxed"></div>
      </div>

      <!-- Step 1 -->
      <div id="step1" class="mt-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 rounded-3xl border border-slate-700/60 bg-slate-900/25 p-6">
            <h3 class="text-title text-2xl font-bold">Step 1 Â· é€‰é¢˜</h3>
            <p class="mt-2 text-base leading-relaxed text-body">æŠ½ä¸€é¢˜ï¼Œæˆ–è€…è‡ªå®šä¹‰ä¸€ä¸ªä½ æƒ³è¦æ”»å…‹çš„è¡¨è¾¾åœºæ™¯ã€‚</p>

            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
              <button id="randomTopicBtn" class="px-5 py-4 rounded-2xl font-bold bg-aurora text-ink shadow-glow hover:-translate-y-0.5 active:scale-95 transition"
                aria-label="éšæœºæŠ½é¢˜">
                <i class="fa-solid fa-dice mr-2"></i>ğŸ² éšæœºæŠ½é¢˜
              </button>
              <div class="rounded-2xl border border-slate-700/60 bg-slate-950/25 p-4">
                <div class="text-sm text-muted">æŠ½é¢˜ç»“æœ</div>
                <div id="topicResult" class="mt-2 text-title font-semibold leading-relaxed">å°šæœªæŠ½é¢˜</div>
              </div>
            </div>

            <div id="lotteryStrip" class="mt-4 hidden rounded-2xl border border-slate-700/60 bg-slate-950/20 p-4">
              <div class="text-xs text-muted mb-2">æŠ½å¥–æ»šåŠ¨ä¸­â€¦</div>
              <div class="h-12 overflow-hidden relative rounded-xl border border-slate-700/40 bg-slate-900/30">
                <div id="lotteryInner" class="absolute inset-0 flex flex-col"></div>
              </div>
            </div>

            <div class="mt-6">
              <label for="customTopic" class="block text-sm font-semibold text-title">âœï¸ è‡ªå®šä¹‰é¢˜ç›®</label>
              <textarea id="customTopic" rows="4"
                class="mt-2 w-full rounded-2xl border border-slate-700/70 bg-slate-950/30 px-4 py-3 text-title placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-aurora/40"
                placeholder="ä¾‹å¦‚ï¼šç”¨ 60 ç§’è¯´æœå›¢é˜Ÿæ¥å—ä¸€ä¸ªäº‰è®®æ–¹æ¡ˆâ€¦ï¼ˆå†™å¾—è¶Šå…·ä½“ï¼ŒAI ç­–ç•¥è¶Šç‹ ï¼‰" aria-label="è‡ªå®šä¹‰é¢˜ç›®è¾“å…¥æ¡†"></textarea>
            </div>

            <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-end">
              <button id="toStep2" class="px-6 py-3 rounded-2xl font-bold bg-gradient-to-r from-aurora to-gold text-ink shadow-glow hover:-translate-y-0.5 active:scale-95 transition disabled:opacity-50 disabled:cursor-not-allowed"
                aria-label="ä¸‹ä¸€æ­¥åˆ°ç­–ç•¥é€‰æ‹©" disabled>
                ä¸‹ä¸€æ­¥ <i class="fa-solid fa-arrow-right ml-2"></i>
              </button>
            </div>
          </div>

          <div class="rounded-3xl border border-slate-700/60 bg-slate-900/25 p-6">
            <h4 class="text-title font-bold">è®­ç»ƒæç¤º</h4>
            <ul class="mt-3 text-sm text-body leading-relaxed space-y-2">
              <li><span class="text-gold font-semibold">-</span> é¢˜ç›®è¶Šå…·ä½“ï¼Œæµ‹è¯„è¶Šå‡†ã€‚</li>
              <li><span class="text-gold font-semibold">-</span> æœªè®¾ç½® Key ä¼šè¢«å¼•å¯¼å»è®¾ç½®é¡µã€‚</li>
              <li><span class="text-gold font-semibold">-</span> è¯„åˆ†ç»´åº¦ï¼šé€»è¾‘ / ç­–ç•¥ / æµç•… / ååº” / æ·±åº¦ã€‚</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Step 2 -->
      <div id="step2" class="mt-6 hidden">
        <div class="rounded-3xl border border-slate-700/60 bg-slate-900/25 p-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h3 class="text-title text-2xl font-bold">Step 2 Â· ç­–ç•¥é€‰æ‹©</h3>
              <p class="mt-2 text-base leading-relaxed text-body">ä» 3 å¥—ä¸åŒæ‰“æ³•é‡Œé€‰ä¸€ä¸ªï¼Œä¸‹ä¸€æ­¥ç”¨å®ƒæ¥æ¼”ç»ƒã€‚</p>
            </div>
            <div class="flex gap-3">
              <button id="backTo1" class="px-4 py-2 rounded-xl border border-slate-700/70 bg-slate-900/40 text-title hover:bg-slate-800/50 hover:-translate-y-0.5 active:scale-95 transition"
                aria-label="è¿”å›é€‰é¢˜">
                <i class="fa-solid fa-arrow-left mr-2"></i>ä¸Šä¸€æ­¥
              </button>
              <button id="refreshStrategiesBtn" class="px-4 py-2 rounded-xl border border-slate-700/70 bg-slate-900/40 text-title hover:bg-slate-800/50 hover:-translate-y-0.5 active:scale-95 transition"
                aria-label="æ¢ä¸€æ‰¹ç­–ç•¥">
                <i class="fa-solid fa-rotate mr-2 text-muted"></i>ğŸ”„ ä¸æ»¡æ„ï¼Ÿæ¢ä¸€æ‰¹
              </button>
            </div>
          </div>

          <div class="mt-6 rounded-2xl border border-slate-700/60 bg-slate-950/20 p-4">
            <div class="text-xs text-muted">é¢˜ç›®</div>
            <div id="step2Topic" class="mt-2 text-title font-semibold leading-relaxed"></div>
          </div>

          <div id="strategySkeleton" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="rounded-2xl border border-slate-700/50 bg-slate-900/30 p-5">
              <div class="skeleton h-5 w-24"></div>
              <div class="mt-4 skeleton h-4 w-full"></div>
              <div class="mt-2 skeleton h-4 w-5/6"></div>
              <div class="mt-2 skeleton h-4 w-4/6"></div>
            </div>
            <div class="rounded-2xl border border-slate-700/50 bg-slate-900/30 p-5">
              <div class="skeleton h-5 w-24"></div>
              <div class="mt-4 skeleton h-4 w-full"></div>
              <div class="mt-2 skeleton h-4 w-5/6"></div>
              <div class="mt-2 skeleton h-4 w-4/6"></div>
            </div>
            <div class="rounded-2xl border border-slate-700/50 bg-slate-900/30 p-5">
              <div class="skeleton h-5 w-24"></div>
              <div class="mt-4 skeleton h-4 w-full"></div>
              <div class="mt-2 skeleton h-4 w-5/6"></div>
              <div class="mt-2 skeleton h-4 w-4/6"></div>
            </div>
          </div>

          <div id="strategiesGrid" class="mt-6 hidden grid grid-cols-1 md:grid-cols-3 gap-4"></div>

          <div class="mt-6 flex justify-end">
            <button id="toStep3" class="px-6 py-3 rounded-2xl font-bold bg-gradient-to-r from-aurora to-gold text-ink shadow-glow hover:-translate-y-0.5 active:scale-95 transition disabled:opacity-50 disabled:cursor-not-allowed"
              aria-label="ä¸‹ä¸€æ­¥åˆ°æ¼”ç»ƒ" disabled>
              ä¸‹ä¸€æ­¥ <i class="fa-solid fa-arrow-right ml-2"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Step 3 -->
      <div id="step3" class="mt-6 hidden">
        <div class="rounded-3xl border border-slate-700/60 bg-slate-900/25 p-6">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h3 class="text-title text-2xl font-bold">Step 3 Â· æ¼”ç»ƒ</h3>
              <p class="mt-2 text-base leading-relaxed text-body">è¯­éŸ³è½¬æ–‡å­— + æ‰‹åŠ¨ä¿®æ”¹ï¼Œå°½é‡è¯´å®Œæ•´ä¸€ç‚¹ã€‚</p>
            </div>
            <button id="backTo2" class="px-4 py-2 rounded-xl border border-slate-700/70 bg-slate-900/40 text-title hover:bg-slate-800/50 hover:-translate-y-0.5 active:scale-95 transition"
              aria-label="è¿”å›ç­–ç•¥é€‰æ‹©">
              <i class="fa-solid fa-arrow-left mr-2"></i>ä¸Šä¸€æ­¥
            </button>
          </div>

          <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="rounded-2xl border border-slate-700/60 bg-slate-950/20 p-5">
              <div class="text-xs text-muted">é¢˜ç›®</div>
              <div id="step3Topic" class="mt-2 text-title font-semibold leading-relaxed"></div>
              <div class="mt-4 text-xs text-muted">ç­–ç•¥</div>
              <div id="step3Strategy" class="mt-2 text-body leading-relaxed"></div>
            </div>

            <div class="rounded-2xl border border-slate-700/60 bg-slate-950/20 p-5">
              <div class="text-title font-bold">å½•éŸ³è¾“å…¥</div>
              <div class="mt-4 flex items-center gap-3">
                <div class="pulse-wrap flex-1" id="pulseWrap" data-on="false">
                  <button id="recordBtn" class="w-full px-5 py-3 rounded-2xl font-bold bg-aurora text-ink shadow-glow hover:-translate-y-0.5 active:scale-95 transition"
                    aria-label="å¼€å§‹æˆ–åœæ­¢å½•éŸ³">
                    <i class="fa-solid fa-microphone mr-2"></i>å¼€å§‹å½•éŸ³
                  </button>
                </div>
                <div id="recBadge" class="hidden px-3 py-2 rounded-xl border border-red-500/40 bg-red-500/10 text-red-200 text-sm">
                  <i class="fa-solid fa-circle mr-2"></i>å½•éŸ³ä¸­
                </div>
              </div>
              <div class="mt-4 text-xs text-muted">è¯­éŸ³è½¬æ–‡å­—ï¼ˆå¯ç¼–è¾‘ï¼‰</div>
              <textarea id="speechText" rows="4"
                class="mt-2 w-full rounded-2xl border border-slate-700/70 bg-slate-950/30 px-4 py-3 text-title placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-aurora/40"
                placeholder="ä½ çš„è¯­éŸ³ä¼šå®æ—¶è½¬æˆæ–‡å­—â€¦" aria-label="è¯­éŸ³è½¬æ–‡å­—è¾“å…¥æ¡†"></textarea>
            </div>
          </div>

          <div class="mt-6 rounded-2xl border border-slate-700/60 bg-slate-950/20 p-5">
            <label for="finalAnswer" class="block text-sm font-semibold text-title">æœ€ç»ˆç¨¿ï¼ˆå¯æ‰‹åŠ¨ä¿®æ”¹/ç›´æ¥æ‰“å­—ï¼‰</label>
            <textarea id="finalAnswer" rows="6"
              class="mt-2 w-full rounded-2xl border border-slate-700/70 bg-slate-950/30 px-4 py-3 text-title placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-aurora/40"
              placeholder="æŠŠä½ çš„è§‚ç‚¹è¯´å®Œæ•´ï¼šç»“è®º â†’ è®ºæ® â†’ åé©³ â†’ æ”¶æŸã€‚è‡³å°‘ 10 å­—ã€‚" aria-label="æœ€ç»ˆå›ç­”è¾“å…¥æ¡†"></textarea>
            <div class="mt-2 flex items-center justify-between gap-3">
              <div id="minLenHint" class="text-sm text-muted">å†å¤šè¯´ä¸¤å¥å§ï¼ˆè‡³å°‘ 10 å­—ï¼‰</div>
              <div class="text-xs text-muted"><span id="answerLen">0</span> å­—</div>
            </div>
          </div>

          <div class="mt-6 flex justify-end">
            <button id="toStep4" class="px-6 py-3 rounded-2xl font-bold bg-gradient-to-r from-aurora to-gold text-ink shadow-glow hover:-translate-y-0.5 active:scale-95 transition disabled:opacity-50 disabled:cursor-not-allowed"
              aria-label="æäº¤æµ‹è¯„" disabled>
              <i class="fa-solid fa-paper-plane mr-2"></i>æäº¤æµ‹è¯„
            </button>
          </div>
        </div>
      </div>

      <!-- Step 4 -->
      <div id="step4" class="mt-6 hidden">
        <div class="rounded-3xl border border-slate-700/60 bg-slate-900/25 p-6">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h3 class="text-title text-2xl font-bold">Step 4 Â· æŠ¥å‘Š</h3>
              <p class="mt-2 text-base leading-relaxed text-body">äº”ç»´é›·è¾¾ + æ¯’èˆŒç‚¹è¯„ï¼ˆæ‰“å­—æœºï¼‰+ é«˜æ‰‹ç¤ºèŒƒã€‚</p>
            </div>
            <button id="backTo3" class="px-4 py-2 rounded-xl border border-slate-700/70 bg-slate-900/40 text-title hover:bg-slate-800/50 hover:-translate-y-0.5 active:scale-95 transition"
              aria-label="è¿”å›æ¼”ç»ƒ">
              <i class="fa-solid fa-arrow-left mr-2"></i>ä¸Šä¸€æ­¥
            </button>
          </div>

          <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="rounded-2xl border border-slate-700/60 bg-slate-950/20 p-5">
              <div class="flex items-end justify-between">
                <div>
                  <div class="text-xs text-muted">æ€»åˆ†</div>
                  <div id="totalScore" class="mt-2 text-6xl font-extrabold text-title">0</div>
                </div>
                <div id="scoreBadge" class="px-3 py-2 rounded-xl text-sm border border-slate-700/60 bg-slate-900/40 text-body">
                  ç­‰å¾…ç”Ÿæˆ
                </div>
              </div>
              <div class="mt-5 h-[340px]">
                <canvas id="radarCanvas" aria-label="é›·è¾¾å›¾" role="img"></canvas>
              </div>
            </div>

            <div class="rounded-2xl border border-slate-700/60 bg-slate-950/20 p-5">
              <div class="text-title font-bold">æ¯’èˆŒç‚¹è¯„</div>
              <div id="typewriter" class="mt-3 text-body leading-relaxed whitespace-pre-wrap min-h-[120px]"></div>
              <div class="mt-6 text-title font-bold">é«˜æ‰‹ç¤ºèŒƒ</div>
              <div id="exampleBox" class="mt-3 rounded-2xl border border-gold/40 bg-gold/10 p-4 text-body leading-relaxed"></div>
            </div>
          </div>

          <div class="mt-6 flex flex-col md:flex-row gap-3">
            <button id="copyBtn" class="px-5 py-3 rounded-2xl border border-slate-700/70 bg-slate-900/40 text-title hover:bg-slate-800/50 hover:-translate-y-0.5 active:scale-95 transition"
              aria-label="å¤åˆ¶å®Œæ•´æŠ¥å‘Š">
              <i class="fa-solid fa-clipboard mr-2 text-muted"></i>ğŸ“‹ å¤åˆ¶å®Œæ•´æŠ¥å‘Š
            </button>
            <button id="saveBtn" class="px-5 py-3 rounded-2xl font-bold bg-gradient-to-r from-aurora to-gold text-ink shadow-glow hover:-translate-y-0.5 active:scale-95 transition"
              aria-label="ä¿å­˜å¹¶è¿”å›é¦–é¡µ">
              <i class="fa-solid fa-floppy-disk mr-2"></i>ğŸ’¾ ä¿å­˜å¹¶è¿”å›
            </button>
            <button id="againBtn" class="px-5 py-3 rounded-2xl border border-slate-700/70 bg-slate-900/40 text-title hover:bg-slate-800/50 hover:-translate-y-0.5 active:scale-95 transition"
              aria-label="å†ç»ƒä¸€é¢˜">
              <i class="fa-solid fa-rotate-right mr-2 text-muted"></i>ğŸ”„ å†ç»ƒä¸€é¢˜
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ----------------------------
    // Storage keys
    // ----------------------------
    const LS = {
      apiKey: 'deepseek_api_key',
      history: 'ai_logic_arena_history_v1'
    };

    // ----------------------------
    // App state
    // ----------------------------
    const app = {
      route: 'home',
      step: 1,
      doneStep: 1,
      topic: '',
      strategy: null,
      strategies: [],
      answer: '',
      eval: null,
      radar: null,
      recognition: null,
      recording: false,
      startedAtMs: null,
      practiceDurationSec: 0,
      typingTimer: null
    };

    // ----------------------------
    // Topic pool
    // ----------------------------
    const TOPICS = [
      'äººå·¥æ™ºèƒ½æ˜¯å¦ä¼šå–ä»£äººç±»çš„å·¥ä½œï¼Ÿ',
      'ç½‘ç»œæ¸¸æˆå¯¹é’å°‘å¹´çš„å½±å“ï¼šåˆ©å¤§äºå¼Šè¿˜æ˜¯å¼Šå¤§äºåˆ©ï¼Ÿ',
      'æ˜¯å¦åº”è¯¥æ”¯æŒ 996 å·¥ä½œåˆ¶ï¼Ÿ',
      'ç¤¾äº¤åª’ä½“æ˜¯å¦è®©äº¤æµæ›´çœŸå®ï¼Ÿ',
      'åœ¨çº¿æ•™è‚²èƒ½å¦å®Œå…¨æ›¿ä»£ä¼ ç»Ÿæ•™è‚²ï¼Ÿ',
      'æ˜¯å¦åº”è¯¥å¯¹ç½‘ç»œè¨€è®ºè¿›è¡Œæ›´ä¸¥æ ¼çš„ç›‘ç®¡ï¼Ÿ',
      'æ¶ˆè´¹ä¸»ä¹‰æ˜¯å¦ä¿ƒè¿›äº†ç¤¾ä¼šè¿›æ­¥ï¼Ÿ',
      'æ˜¯å¦åº”è¯¥å–æ¶ˆé«˜è€ƒï¼Ÿ',
      'AI çš„å‘å±•æ˜¯å¦åº”è¯¥å—åˆ°é™åˆ¶ï¼Ÿ',
      'æ˜¯å¦åº”è¯¥æ”¯æŒæ­»åˆ‘ï¼Ÿ',
      'é¢å¯¹è´¨ç–‘æ—¶ï¼Œå¦‚ä½•åœ¨ 60 ç§’å†…ç»™å‡ºé€»è¾‘é—­ç¯çš„å›åº”ï¼Ÿ',
      'å›¢é˜Ÿäº‰è®ºåƒµå±€æ—¶ï¼Œå¦‚ä½•å¿«é€Ÿç»Ÿä¸€å†³ç­–æ ‡å‡†ï¼Ÿ'
    ];

    // ----------------------------
    // DOM helpers
    // ----------------------------
    const $ = (id) => document.getElementById(id);
    const esc = (s) => String(s ?? '')
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#039;");

    function todayKey(d = new Date()) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    // ----------------------------
    // Toast (Success/Error/Info, 3s auto dismiss)
    // ----------------------------
    function toast(type, title, message) {
      const host = $('toastHost');
      const id = 't_' + Math.random().toString(16).slice(2);
      const palette = {
        success: { b: 'border-aurora/40', bg: 'bg-aurora/10', i: 'fa-circle-check text-aurora' },
        error:   { b: 'border-red-500/40', bg: 'bg-red-500/10', i: 'fa-triangle-exclamation text-red-300' },
        info:    { b: 'border-gold/40', bg: 'bg-gold/10', i: 'fa-circle-info text-gold' }
      }[type] || { b: 'border-slate-700/60', bg: 'bg-slate-900/40', i: 'fa-circle-info text-muted' };

      const el = document.createElement('div');
      el.id = id;
      el.className = `animate__animated animate__fadeInDown rounded-2xl border ${palette.b} ${palette.bg} backdrop-blur px-4 py-3 shadow-xl`;
      el.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="mt-0.5"><i class="fa-solid ${palette.i}"></i></div>
          <div class="flex-1">
            <div class="text-title font-bold text-sm">${esc(title)}</div>
            <div class="text-body text-sm leading-relaxed mt-1">${esc(message)}</div>
          </div>
          <button class="text-muted hover:text-title transition" aria-label="å…³é—­é€šçŸ¥" data-close="${id}">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
      `;
      host.appendChild(el);

      const close = () => {
        const node = $(id);
        if (!node) return;
        node.classList.remove('animate__fadeInDown');
        node.classList.add('animate__fadeOutUp');
        setTimeout(() => node.remove(), 250);
      };

      el.querySelector(`[data-close="${id}"]`).addEventListener('click', close);
      setTimeout(close, 3000);
    }

    // ----------------------------
    // Confirm modal
    // ----------------------------
    function confirmModal({ title, desc, okText = 'ç¡®è®¤', onOk }) {
      $('confirmTitle').textContent = title;
      $('confirmDesc').textContent = desc;
      $('confirmOk').textContent = okText;
      $('confirmOverlay').classList.remove('hidden');

      const cleanup = () => {
        $('confirmOverlay').classList.add('hidden');
        $('confirmOk').onclick = null;
      };

      $('confirmClose').onclick = cleanup;
      $('confirmCancel').onclick = cleanup;
      $('confirmOverlay').onclick = (e) => {
        if (e.target === $('confirmOverlay')) cleanup();
      };
      $('confirmOk').onclick = () => {
        cleanup();
        onOk?.();
      };
    }

    // ----------------------------
    // Router / Views
    // ----------------------------
    function setRoute(route) {
      app.route = route;
      const map = { home: 'homeView', settings: 'settingsView', history: 'historyView', training: 'trainingView' };
      for (const key of Object.values(map)) $(key).classList.remove('active');
      $(map[route]).classList.add('active');

      // nav active style
      document.querySelectorAll('.navBtn').forEach(btn => {
        const active = btn.dataset.route === route;
        btn.classList.toggle('border-aurora/50', active);
        btn.classList.toggle('bg-aurora/10', active);
      });

      if (route === 'history') renderHistory();
      if (route === 'settings') syncKeyUI();
      if (route === 'home') renderStats();
    }

    // ----------------------------
    // Drawer
    // ----------------------------
    function openDrawer() {
      $('drawerOverlay').classList.remove('hidden');
    }
    function closeDrawer() {
      $('drawerOverlay').classList.add('hidden');
    }

    // ----------------------------
    // API helpers (DeepSeek)
    // ----------------------------
    function getApiKey() {
      return (localStorage.getItem(LS.apiKey) || '').trim();
    }

    function showApiAlert(msg) {
      $('apiAlertText').textContent = msg;
      $('apiAlert').classList.remove('hidden');
    }
    function clearApiAlert() {
      $('apiAlert').classList.add('hidden');
      $('apiAlertText').textContent = '';
    }

    function extractJsonCandidate(text) {
      const s = String(text ?? '').trim();
      const fenced = s.match(/```(?:json)?\s*([\s\S]*?)\s*```/i);
      if (fenced?.[1]) return fenced[1].trim();
      return s;
    }

    async function deepseekChat({ apiKey, userPrompt }) {
      const res = await fetch('https://api.deepseek.com/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'deepseek-chat',
          messages: [{ role: 'user', content: userPrompt }],
          temperature: 0.7
        })
      });

      let payload = null;
      try { payload = await res.json(); } catch (_) {}

      if (!res.ok) {
        const code = payload?.error?.code || res.status;
        const msg = payload?.error?.message || res.statusText || 'è¯·æ±‚å¤±è´¥';
        const friendly =
          res.status === 401 ? '401ï¼šAPI Key æ— æ•ˆæˆ–å·²è¿‡æœŸã€‚è¯·å»ã€è®¾ç½®ã€‘é‡æ–°å¡«å†™æ­£ç¡®çš„ Keyã€‚' :
          res.status === 429 ? '429ï¼šè¯·æ±‚è¿‡äºé¢‘ç¹ã€‚ç¨ç­‰ç‰‡åˆ»å†è¯•ã€‚' :
          `è¯·æ±‚å¤±è´¥ï¼ˆ${code}ï¼‰ï¼š${msg}`;
        throw new Error(friendly);
      }

      const content = payload?.choices?.[0]?.message?.content;
      if (!content) throw new Error('AI è¿”å›ä¸ºç©ºï¼Œè¯·ç¨åé‡è¯•ã€‚');
      return content;
    }

    // ----------------------------
    // Training flow (steps)
    // ----------------------------
    function setStep(step) {
      app.step = step;
      app.doneStep = Math.max(app.doneStep, step);
      const pct = `${(step / 4) * 100}%`;
      $('progressBar').style.width = pct;

      $('step1').classList.toggle('hidden', step !== 1);
      $('step2').classList.toggle('hidden', step !== 2);
      $('step3').classList.toggle('hidden', step !== 3);
      $('step4').classList.toggle('hidden', step !== 4);

      document.querySelectorAll('.crumb').forEach(btn => {
        const s = Number(btn.dataset.step);
        const isActive = s === step;
        const canGo = s <= app.doneStep;
        btn.disabled = !canGo;
        btn.classList.toggle('opacity-50', !canGo);
        btn.classList.toggle('cursor-not-allowed', !canGo);
        btn.classList.toggle('border-aurora/60', isActive);
        btn.classList.toggle('bg-aurora/10', isActive);
      });
    }

    function resetTraining() {
      clearApiAlert();
      app.step = 1;
      app.doneStep = 1;
      app.topic = '';
      app.strategy = null;
      app.strategies = [];
      app.answer = '';
      app.eval = null;
      app.startedAtMs = null;
      app.practiceDurationSec = 0;
      stopTyping();
      stopRecording();

      $('topicResult').textContent = 'å°šæœªæŠ½é¢˜';
      $('customTopic').value = '';
      $('toStep2').disabled = true;

      $('step2Topic').textContent = '';
      $('strategiesGrid').innerHTML = '';
      $('strategiesGrid').classList.add('hidden');
      $('strategySkeleton').classList.remove('hidden');
      $('toStep3').disabled = true;

      $('step3Topic').textContent = '';
      $('step3Strategy').textContent = '';
      $('speechText').value = '';
      $('finalAnswer').value = '';
      $('answerLen').textContent = '0';
      $('minLenHint').textContent = 'å†å¤šè¯´ä¸¤å¥å§ï¼ˆè‡³å°‘ 10 å­—ï¼‰';
      $('toStep4').disabled = true;

      $('totalScore').textContent = '0';
      $('scoreBadge').textContent = 'ç­‰å¾…ç”Ÿæˆ';
      $('typewriter').textContent = '';
      $('exampleBox').textContent = '';
      if (app.radar) { app.radar.destroy(); app.radar = null; }

      setStep(1);
    }

    function ensureKeyOrGuide() {
      const key = getApiKey();
      if (!key) {
        toast('error', 'æœªé…ç½® Key', 'è¯·å…ˆå»ã€è®¾ç½®ã€‘å¡«å†™ DeepSeek API Keyï¼Œæ‰èƒ½ç»§ç»­è®­ç»ƒã€‚');
        setRoute('settings');
        return null;
      }
      return key;
    }

    // Step 1: topic
    function updateTopicNextBtn() {
      const custom = $('customTopic').value.trim();
      const has = Boolean(custom || app.topic);
      $('toStep2').disabled = !has;
    }

    async function randomTopic() {
      const btn = $('randomTopicBtn');
      btn.disabled = true;
      $('lotteryStrip').classList.remove('hidden');
      $('lotteryInner').innerHTML = '';

      const roll = [];
      for (let i = 0; i < 24; i++) roll.push(TOPICS[i % TOPICS.length]);
      roll.forEach(t => {
        const row = document.createElement('div');
        row.className = 'h-12 flex items-center justify-center text-sm text-body';
        row.textContent = t;
        $('lotteryInner').appendChild(row);
      });

      // "æ»šåŠ¨æŠ½å¥–"ï¼šåŠ é€Ÿåå‡é€Ÿçš„ä½ç§»
      const target = TOPICS[Math.floor(Math.random() * TOPICS.length)];
      const totalPx = 12 * 48 + Math.floor(Math.random() * 6) * 48;
      const inner = $('lotteryInner');
      inner.style.transform = 'translateY(0px)';
      inner.style.transition = 'transform 1.1s cubic-bezier(.12,.68,.19,1)';
      await new Promise(r => requestAnimationFrame(r));
      inner.style.transform = `translateY(-${totalPx}px)`;

      setTimeout(() => {
        app.topic = target;
        $('topicResult').textContent = target;
        $('lotteryStrip').classList.add('hidden');
        btn.disabled = false;
        updateTopicNextBtn();
      }, 1150);
    }

    // Step 2: strategies
    function renderStrategySkeleton() {
      $('strategySkeleton').classList.remove('hidden');
      $('strategiesGrid').classList.add('hidden');
      $('strategiesGrid').innerHTML = '';
      $('toStep3').disabled = true;
      app.strategy = null;
    }

    function renderStrategies(list) {
      $('strategySkeleton').classList.add('hidden');
      $('strategiesGrid').classList.remove('hidden');
      $('strategiesGrid').innerHTML = '';
      app.strategy = null;
      $('toStep3').disabled = true;

      list.forEach((s, idx) => {
        const card = document.createElement('button');
        card.type = 'button';
        card.className = 'text-left rounded-2xl border border-slate-700/60 bg-slate-900/35 p-5 hover:bg-slate-800/40 hover:-translate-y-0.5 active:scale-95 transition';
        card.setAttribute('aria-label', `é€‰æ‹©ç­–ç•¥ ${idx + 1}`);
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-sm text-gold font-bold">ç­–ç•¥ ${idx + 1}</div>
              <div class="mt-3 text-body leading-relaxed">${esc(s)}</div>
            </div>
            <div class="mt-1 text-aurora opacity-0"><i class="fa-solid fa-circle-check"></i></div>
          </div>
        `;
        card.addEventListener('click', () => {
          document.querySelectorAll('#strategiesGrid > button').forEach(b => {
            b.classList.remove('border-aurora/70');
            b.classList.add('border-slate-700/60');
            b.querySelector('.fa-circle-check')?.parentElement?.classList?.add('opacity-0');
          });
          card.classList.add('border-aurora/70');
          card.classList.remove('border-slate-700/60');
          card.querySelector('.fa-circle-check')?.parentElement?.classList?.remove('opacity-0');
          app.strategy = s;
          $('toStep3').disabled = false;
          toast('success', 'ç­–ç•¥å·²é”å®š', 'ä¸‹ä¸€æ­¥ç”¨è¿™å¥—æ‰“æ³•å¼€å§‹æ¼”ç»ƒã€‚');
        });
        $('strategiesGrid').appendChild(card);
      });
    }

    async function fetchStrategies() {
      clearApiAlert();
      renderStrategySkeleton();
      const apiKey = ensureKeyOrGuide();
      if (!apiKey) return;

      const prompt = [
        'ä½ æ˜¯â€œé€»è¾‘å£æ‰ç‰¹è®­â€çš„ç­–ç•¥ç”Ÿæˆå™¨ã€‚',
        `é¢˜ç›®ï¼š${app.topic}`,
        '',
        'è¯·ç”Ÿæˆ 3 æ¡äº’ä¸ç›¸åŒã€å¯æ‰§è¡Œçš„æ¼”è®²/è¾©è®ºç­–ç•¥ï¼Œæ¯æ¡ä¸è¶…è¿‡ 60 å­—ã€‚',
        'å¿…é¡»ä¸¥æ ¼åªè¿”å›ä¸€ä¸ª JSON æ•°ç»„ï¼ˆä¸è¦ä»»ä½•è§£é‡Šã€ä¸è¦ Markdownï¼‰ï¼š',
        '["ç­–ç•¥1","ç­–ç•¥2","ç­–ç•¥3"]'
      ].join('\\n');

      try {
        const content = await deepseekChat({ apiKey, userPrompt: prompt });
        const json = extractJsonCandidate(content);
        const arr = JSON.parse(json);
        if (!Array.isArray(arr) || arr.length < 3) throw new Error('AI è¿”å›çš„ç­–ç•¥æ ¼å¼ä¸æ­£ç¡®ã€‚');
        app.strategies = arr.slice(0, 3).map(x => String(x));
        renderStrategies(app.strategies);
      } catch (e) {
        showApiAlert(e.message || 'ç­–ç•¥ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚');
        renderStrategies([
          'å…ˆç»™ç»“è®ºï¼Œå†ç»™ 2 ä¸ªå¯éªŒè¯è®ºæ®ï¼Œæœ€åæ”¶æŸæˆä¸€å¥â€œå› æ­¤â€ã€‚',
          'ç”¨â€œå¯¹æ–¹æ‹…å¿§ â†’ åé©³ â†’ æ›¿ä»£æ–¹æ¡ˆâ€ä¸‰æ®µå¼æ¨è¿›ï¼Œé¿å…æƒ…ç»ªå¯¹æ’ã€‚',
          'ç”¨â€œå®šä¹‰æ ‡å‡† â†’ ä¸¾ä¾‹ â†’ å¯¹æ¯” â†’ å½’çº³â€è®©è®ºè¯å½¢æˆé—­ç¯ã€‚'
        ]);
      }
    }

    // Step 3: speaking
    function initSpeech() {
      if (app.recognition) return true;
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        toast('info', 'æµè§ˆå™¨é™åˆ¶', 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ Web Speech APIï¼ˆè¯­éŸ³è½¬æ–‡å­—ï¼‰ã€‚ä½ ä»å¯æ‰‹åŠ¨è¾“å…¥ã€‚');
        return false;
      }
      app.recognition = new SR();
      app.recognition.lang = 'zh-CN';
      app.recognition.continuous = true;
      app.recognition.interimResults = true;
      app.recognition.onresult = (event) => {
        let text = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          text += event.results[i][0].transcript;
        }
        $('speechText').value = text.trim();
        if (!$('finalAnswer').value.trim()) {
          // é»˜è®¤æŠŠè¯­éŸ³å†…å®¹åŒæ­¥åˆ°æœ€ç»ˆç¨¿ï¼Œå…è®¸æ‰‹åŠ¨è¦†ç›–
          $('finalAnswer').value = text.trim();
        }
        onAnswerChange();
      };
      app.recognition.onerror = () => {
        toast('error', 'è¯­éŸ³è¯†åˆ«å¤±è´¥', 'å¯èƒ½æ˜¯æƒé™æˆ–ç¯å¢ƒå™ªå£°å¯¼è‡´ï¼Œå»ºè®®æ”¹ä¸ºæ‰‹åŠ¨è¾“å…¥ã€‚');
        stopRecording();
      };
      app.recognition.onend = () => {
        // å½•éŸ³è‡ªç„¶ç»“æŸæ—¶ï¼Œä¿æŒ UI å…³é—­
        stopRecording(true);
      };
      return true;
    }

    function startRecording() {
      if (!initSpeech()) return;
      if (app.recording) return;
      try {
        app.recording = true;
        $('pulseWrap').dataset.on = 'true';
        $('recBadge').classList.remove('hidden');
        $('recordBtn').innerHTML = '<i class="fa-solid fa-stop mr-2"></i>åœæ­¢å½•éŸ³';
        app.recognition.start();
      } catch (_) {
        toast('error', 'æ— æ³•å¼€å§‹å½•éŸ³', 'è¯·æ£€æŸ¥éº¦å…‹é£æƒé™ï¼Œæˆ–ç›´æ¥æ‰‹åŠ¨è¾“å…¥ã€‚');
        stopRecording(true);
      }
    }

    function stopRecording(silent = false) {
      if (!app.recording && !app.recognition) return;
      app.recording = false;
      $('pulseWrap').dataset.on = 'false';
      $('recBadge').classList.add('hidden');
      $('recordBtn').innerHTML = '<i class="fa-solid fa-microphone mr-2"></i>å¼€å§‹å½•éŸ³';
      try { app.recognition?.stop(); } catch (_) {}
      if (!silent) toast('info', 'å½•éŸ³ç»“æŸ', 'ä½ å¯ä»¥åœ¨æœ€ç»ˆç¨¿é‡Œå¾®è°ƒå†…å®¹å†æäº¤ã€‚');
    }

    function onAnswerChange() {
      const text = $('finalAnswer').value.trim();
      $('answerLen').textContent = String(text.length);
      const ok = text.length >= 10;
      $('toStep4').disabled = !ok;
      $('minLenHint').textContent = ok ? 'å¯ä»¥æäº¤æµ‹è¯„äº†' : 'å†å¤šè¯´ä¸¤å¥å§ï¼ˆè‡³å°‘ 10 å­—ï¼‰';
      $('minLenHint').classList.toggle('text-aurora', ok);
      $('minLenHint').classList.toggle('text-muted', !ok);
      app.answer = text;
    }

    // Step 4: evaluation + typing + radar
    function stopTyping() {
      if (app.typingTimer) {
        clearInterval(app.typingTimer);
        app.typingTimer = null;
      }
    }

    function typewriter(text) {
      stopTyping();
      const box = $('typewriter');
      box.textContent = '';
      const s = String(text ?? '');
      let i = 0;
      app.typingTimer = setInterval(() => {
        i += 1;
        box.textContent = s.slice(0, i);
        if (i >= s.length) {
          stopTyping();
          // æ‰“å­—æœºç»“æŸåï¼Œç”¨ Markdown æ¸²æŸ“æœ€ç»ˆæ’ç‰ˆ
          box.innerHTML = marked.parse(s);
        }
      }, 16);
    }

    function setScoreUI(total) {
      const n = Number(total) || 0;
      const el = $('totalScore');
      if (n >= 85) {
        el.className = 'mt-2 text-6xl font-extrabold text-gold';
        $('scoreBadge').textContent = 'é«˜åˆ† Â· é‡‘è‰²æ®µä½';
        $('scoreBadge').className = 'px-3 py-2 rounded-xl text-sm border border-gold/40 bg-gold/10 text-gold';
      } else if (n >= 60) {
        el.className = 'mt-2 text-6xl font-extrabold text-aurora';
        $('scoreBadge').textContent = 'åŠæ ¼ Â· ç»§ç»­åŠ ç ';
        $('scoreBadge').className = 'px-3 py-2 rounded-xl text-sm border border-aurora/40 bg-aurora/10 text-aurora';
      } else {
        el.className = 'mt-2 text-6xl font-extrabold text-red-300';
        $('scoreBadge').textContent = 'æœªåŠæ ¼ Â· éœ€è¦é‡æ„é€»è¾‘';
        $('scoreBadge').className = 'px-3 py-2 rounded-xl text-sm border border-red-500/40 bg-red-500/10 text-red-200';
      }
      el.textContent = String(n);
    }

    function renderRadar(scores) {
      const dims = ['é€»è¾‘','ç­–ç•¥','æµç•…','ååº”','æ·±åº¦'];
      const vals = dims.map(k => Math.max(0, Math.min(100, Number(scores?.[k] ?? 0))));
      if (app.radar) { app.radar.destroy(); app.radar = null; }
      const ctx = $('radarCanvas').getContext('2d');
      app.radar = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: dims,
          datasets: [{
            data: vals,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16,185,129,.12)',
            pointBackgroundColor: '#10b981',
            pointBorderColor: '#f8fafc',
            pointHoverBackgroundColor: '#f8fafc',
            pointHoverBorderColor: '#10b981',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            r: {
              min: 0,
              max: 100,
              ticks: { stepSize: 20, color: '#cbd5e1', backdropColor: 'transparent' },
              grid: { color: 'rgba(148,163,184,.18)' },
              angleLines: { color: 'rgba(148,163,184,.18)' },
              pointLabels: { color: '#f8fafc', font: { size: 12, weight: '600' } }
            }
          }
        }
      });
    }

    async function submitEvaluation() {
      clearApiAlert();
      const apiKey = ensureKeyOrGuide();
      if (!apiKey) return;

      // è®°å½•æ—¶é•¿ï¼šä» step3 è¿›å…¥å¼€å§‹ç®—
      if (app.startedAtMs) {
        app.practiceDurationSec = Math.max(1, Math.round((Date.now() - app.startedAtMs) / 1000));
      }

      // æäº¤æ—¶ç”¨éª¨æ¶å±ï¼ˆè¿™é‡Œç”¨â€œå³ä¾§å†…å®¹å ä½â€ï¼‰
      $('typewriter').textContent = '';
      $('exampleBox').textContent = '';
      $('exampleBox').classList.add('skeleton');
      $('typewriter').classList.add('skeleton');

      const prompt = [
        'ä½ æ˜¯â€œAI é€»è¾‘å£æ‰ç‰¹è®­â€çš„æ¯’èˆŒæµ‹è¯„å®˜ã€‚å¿…é¡»ä¸¥æ ¼è¾“å‡º JSON å¯¹è±¡ï¼Œä¸èƒ½è¾“å‡ºä»»ä½•å…¶ä»–æ–‡å­—ã€‚',
        '',
        `é¢˜ç›®ï¼š${app.topic}`,
        `ç­–ç•¥ï¼š${app.strategy}`,
        `å›ç­”ï¼š${app.answer}`,
        '',
        'è¯·è¾“å‡ºä¸¥æ ¼ JSONï¼ˆä¸å…è®¸ Markdown ä»£ç å—ï¼Œä¸å…è®¸è§£é‡Šï¼‰ï¼š',
        '{',
        '  "scores": {"é€»è¾‘":0-100,"ç­–ç•¥":0-100,"æµç•…":0-100,"ååº”":0-100,"æ·±åº¦":0-100},',
        '  "total_score": 0-100,',
        '  "comment": "æ¯’èˆŒç‚¹è¯„ï¼ˆMarkdown è¯­æ³•å¯ç”¨ï¼‰",',
        '  "example": "é«˜æ‰‹ç¤ºèŒƒï¼ˆç»™å‡ºå¯ç›´æ¥èƒŒè¯µçš„ä¼˜åŒ–é‡‘å¥/ç»“æ„ï¼‰"',
        '}'
      ].join('\\n');

      try {
        const content = await deepseekChat({ apiKey, userPrompt: prompt });
        const json = extractJsonCandidate(content);
        const obj = JSON.parse(json);
        if (!obj || typeof obj !== 'object') throw new Error('AI è¿”å›æ ¼å¼å¼‚å¸¸ã€‚');
        if (!obj.scores || typeof obj.scores !== 'object') throw new Error('ç¼ºå°‘ scores å­—æ®µã€‚');

        app.eval = {
          scores: obj.scores,
          total_score: Number(obj.total_score ?? 0),
          comment: String(obj.comment ?? ''),
          example: String(obj.example ?? '')
        };

        // UI
        $('exampleBox').classList.remove('skeleton');
        $('typewriter').classList.remove('skeleton');
        $('exampleBox').innerHTML = marked.parse(app.eval.example || '');
        setScoreUI(app.eval.total_score);
        renderRadar(app.eval.scores);

        // æ‰“å­—æœºï¼ˆMarkdown æ¸²æŸ“ä¼šç ´åé€å­—å±•ç¤ºï¼Œè¿™é‡Œå…ˆé€å­—æ˜¾ç¤ºçº¯æ–‡æœ¬ï¼›å¤åˆ¶/ä¿å­˜é‡ŒåŒ…å« Markdown åŸæ–‡ï¼‰
        typewriter(app.eval.comment || '');

        setStep(4);
        toast('success', 'æŠ¥å‘Šå·²ç”Ÿæˆ', 'ä½ å¯ä»¥å¤åˆ¶ã€ä¿å­˜æˆ–å†ç»ƒä¸€é¢˜ã€‚');
      } catch (e) {
        $('exampleBox').classList.remove('skeleton');
        $('typewriter').classList.remove('skeleton');
        showApiAlert(e.message || 'æµ‹è¯„å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚');
        toast('error', 'æµ‹è¯„å¤±è´¥', 'å·²åœ¨é¡µé¢ä¸Šæ–¹å±•ç¤ºå‹å¥½é”™è¯¯æç¤ºã€‚');
      }
    }

    // ----------------------------
    // History + stats
    // ----------------------------
    function readHistory() {
      try {
        const raw = localStorage.getItem(LS.history);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch (_) {
        return [];
      }
    }

    function writeHistory(arr) {
      localStorage.setItem(LS.history, JSON.stringify(arr));
    }

    function rankFrom(totalCount, avg) {
      if (totalCount >= 50 && avg >= 85) return 'å“²å­¦å¤§å¸ˆ';
      if (totalCount >= 20 && avg >= 75) return 'è¿›é˜¶è¾©æ‰‹';
      if (totalCount >= 8 && avg >= 65) return 'é€»è¾‘å­¦å¾’';
      return 'é€»è¾‘èŒæ–°';
    }

    function renderStats() {
      const h = readHistory();
      const count = h.length;
      const avg = count ? Math.round(h.reduce((s, x) => s + (Number(x.total_score) || 0), 0) / count) : 0;
      const today = todayKey();
      const todaySec = h.filter(x => x?.day === today).reduce((s, x) => s + (Number(x.duration_sec) || 0), 0);
      const todayMin = Math.round(todaySec / 60);

      $('statTotalCount').textContent = String(count);
      $('statAvgScore').textContent = String(avg);
      $('statTodayMinutes').textContent = `${todayMin} åˆ†é’Ÿ`;
      $('rankText').textContent = rankFrom(count, avg);
    }

    function renderHistory() {
      const h = readHistory();
      if (!h.length) {
        $('historyEmpty').classList.remove('hidden');
        $('historyGrid').classList.add('hidden');
        $('historyGrid').innerHTML = '';
        return;
      }
      $('historyEmpty').classList.add('hidden');
      $('historyGrid').classList.remove('hidden');
      $('historyGrid').innerHTML = '';

      h.forEach((item, idx) => {
        const dt = new Date(item.created_at || Date.now());
        const dateStr = dt.toLocaleString('zh-CN', { hour12: false });
        const score = Number(item.total_score) || 0;
        const scoreCls = score >= 85 ? 'text-gold' : score >= 60 ? 'text-aurora' : 'text-red-300';
        const tags = Array.isArray(item.tags) ? item.tags : [];
        const id = `acc_${idx}`;
        const card = document.createElement('div');
        card.className = 'rounded-3xl border border-slate-700/60 bg-slate-900/25 p-6 hover:bg-slate-800/25 transition';
        card.innerHTML = `
          <button class="w-full text-left" aria-label="å±•å¼€å†å²è¯¦æƒ…" data-acc="${id}">
            <div class="flex items-start justify-between gap-4">
              <div>
                <div class="text-xs text-muted">${esc(dateStr)}</div>
                <div class="mt-2 text-title font-bold leading-relaxed">${esc(item.topic || '')}</div>
                <div class="mt-3 flex flex-wrap gap-2">
                  ${tags.map(t => `<span class="text-xs px-2 py-1 rounded-lg border border-slate-700/60 bg-slate-900/40 text-body">${esc(t)}</span>`).join('')}
                </div>
              </div>
              <div class="text-right">
                <div class="text-xs text-muted">æ€»åˆ†</div>
                <div class="mt-1 text-3xl font-extrabold ${scoreCls}">${score}</div>
                <div class="mt-2 text-xs text-muted"><i class="fa-solid fa-chevron-down"></i></div>
              </div>
            </div>
          </button>
          <div id="${id}" class="accordion mt-4">
            <div class="rounded-2xl border border-slate-700/60 bg-slate-950/20 p-4">
              <div class="text-xs text-muted">ç­–ç•¥</div>
              <div class="mt-2 text-body leading-relaxed">${esc(item.strategy || '')}</div>
              <div class="mt-4 text-xs text-muted">å›ç­”</div>
              <div class="mt-2 text-body leading-relaxed whitespace-pre-wrap">${esc(item.answer || '')}</div>
              <div class="mt-4 text-xs text-muted">æ¯’èˆŒç‚¹è¯„</div>
              <div class="mt-2 prose prose-invert max-w-none text-body">${marked.parse(item.comment_md || '')}</div>
              <div class="mt-4 text-xs text-muted">é«˜æ‰‹ç¤ºèŒƒ</div>
              <div class="mt-2 rounded-2xl border border-gold/40 bg-gold/10 p-3 text-body">${marked.parse(item.example_md || '')}</div>
            </div>
          </div>
        `;
        card.querySelector(`[data-acc="${id}"]`).addEventListener('click', () => {
          const acc = $(id);
          const open = acc.classList.toggle('open');
          if (open) acc.style.maxHeight = acc.scrollHeight + 'px';
          else acc.style.maxHeight = '0px';
        });
        $('historyGrid').appendChild(card);
      });
    }

    // ----------------------------
    // Settings key UI
    // ----------------------------
    function maskKey(key) {
      if (!key) return 'æœªè®¾ç½®';
      if (key.length <= 8) return key.slice(0, 2) + '****';
      return `${key.slice(0, 3)}****${key.slice(-4)}`;
    }

    function syncKeyUI() {
      const key = getApiKey();
      $('apiKeyInput').value = key;
      $('maskedKey').textContent = maskKey(key);
    }

    // ----------------------------
    // Wire up events
    // ----------------------------
    document.addEventListener('DOMContentLoaded', () => {
      // Brand
      $('brandBtn').addEventListener('click', () => setRoute('home'));

      // Nav buttons
      document.querySelectorAll('.navBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          setRoute(btn.dataset.route);
          closeDrawer();
        });
      });

      // Drawer
      $('menuBtn').addEventListener('click', openDrawer);
      $('drawerClose').addEventListener('click', closeDrawer);
      $('drawerOverlay').addEventListener('click', (e) => { if (e.target === $('drawerOverlay')) closeDrawer(); });

      // Home
      $('startTrainingBtn').addEventListener('click', () => {
        setRoute('training');
        resetTraining();
      });
      $('goSettingsFromHero').addEventListener('click', () => setRoute('settings'));

      // Settings
      $('backHomeFromSettings').addEventListener('click', () => setRoute('home'));
      $('toggleKeyVisibility').addEventListener('click', () => {
        const isPwd = $('apiKeyInput').type === 'password';
        $('apiKeyInput').type = isPwd ? 'text' : 'password';
        $('toggleKeyVisibility').innerHTML = isPwd ? '<i class="fa-regular fa-eye-slash"></i>' : '<i class="fa-regular fa-eye"></i>';
      });
      $('saveKeyBtn').addEventListener('click', () => {
        const v = $('apiKeyInput').value.trim();
        if (!v) {
          toast('info', 'æœªå¡«å†™', 'è¯·å…ˆè¾“å…¥ç±»ä¼¼ â€œsk-...â€ çš„ API Keyã€‚');
          return;
        }
        localStorage.setItem(LS.apiKey, v);
        syncKeyUI();
        toast('success', 'å·²ä¿å­˜', 'API Key å·²ä¿å­˜å¹¶æ˜¾ç¤ºæ©ç ã€‚');
      });
      $('clearHistoryBtn').addEventListener('click', () => {
        confirmModal({
          title: 'ç¡®è®¤æ¸…é™¤å†å²ï¼Ÿ',
          desc: 'è¿™ä¼šåˆ é™¤æ‰€æœ‰å†å²è®°å½•ä¸ç»Ÿè®¡æ•°æ®ï¼Œä¸”ä¸å¯æ¢å¤ã€‚',
          okText: 'ç¡®è®¤æ¸…é™¤',
          onOk: () => {
            localStorage.removeItem(LS.history);
            toast('success', 'å·²æ¸…é™¤', 'å†å²è®°å½•å·²æ¸…é™¤ã€‚');
            renderStats();
            if (app.route === 'history') renderHistory();
          }
        });
      });

      // History
      $('backHomeFromHistory').addEventListener('click', () => setRoute('home'));

      // Breadcrumbs
      document.querySelectorAll('.crumb').forEach(btn => {
        btn.addEventListener('click', () => {
          const target = Number(btn.dataset.step);
          if (target <= app.doneStep) setStep(target);
        });
      });

      // Step 1
      $('randomTopicBtn').addEventListener('click', randomTopic);
      $('customTopic').addEventListener('input', () => {
        if ($('customTopic').value.trim()) {
          app.topic = '';
          $('topicResult').textContent = 'ï¼ˆä½¿ç”¨è‡ªå®šä¹‰é¢˜ç›®ï¼‰';
        }
        updateTopicNextBtn();
      });
      $('toStep2').addEventListener('click', () => {
        const key = ensureKeyOrGuide();
        if (!key) return;
        const custom = $('customTopic').value.trim();
        app.topic = custom || app.topic;
        if (!app.topic) {
          toast('info', 'è¿˜å·®ä¸€æ­¥', 'å…ˆæŠ½é¢˜æˆ–å¡«å†™è‡ªå®šä¹‰é¢˜ç›®ã€‚');
          return;
        }
        $('step2Topic').textContent = app.topic;
        setStep(2);
        fetchStrategies();
      });

      // Step 2
      $('backTo1').addEventListener('click', () => setStep(1));
      $('refreshStrategiesBtn').addEventListener('click', fetchStrategies);
      $('toStep3').addEventListener('click', () => {
        if (!app.strategy) {
          toast('info', 'æœªé€‰æ‹©ç­–ç•¥', 'ç‚¹é€‰ä¸€å¼ ç­–ç•¥å¡ç‰‡å†ç»§ç»­ã€‚');
          return;
        }
        $('step3Topic').textContent = app.topic;
        $('step3Strategy').textContent = app.strategy;
        app.startedAtMs = Date.now();
        setStep(3);
      });

      // Step 3
      $('backTo2').addEventListener('click', () => setStep(2));
      $('recordBtn').addEventListener('click', () => {
        if (app.recording) stopRecording();
        else startRecording();
      });
      $('speechText').addEventListener('input', () => {
        if (!$('finalAnswer').value.trim()) $('finalAnswer').value = $('speechText').value;
        onAnswerChange();
      });
      $('finalAnswer').addEventListener('input', onAnswerChange);
      $('toStep4').addEventListener('click', submitEvaluation);

      // Step 4
      $('backTo3').addEventListener('click', () => setStep(3));
      $('copyBtn').addEventListener('click', async () => {
        if (!app.eval) return;
        const report = [
          `é¢˜ç›®ï¼š${app.topic}`,
          `ç­–ç•¥ï¼š${app.strategy}`,
          `å›ç­”ï¼š${app.answer}`,
          `æ€»åˆ†ï¼š${app.eval.total_score}`,
          `äº”ç»´ï¼šé€»è¾‘ ${app.eval.scores?.['é€»è¾‘'] ?? 0}ï½œç­–ç•¥ ${app.eval.scores?.['ç­–ç•¥'] ?? 0}ï½œæµç•… ${app.eval.scores?.['æµç•…'] ?? 0}ï½œååº” ${app.eval.scores?.['ååº”'] ?? 0}ï½œæ·±åº¦ ${app.eval.scores?.['æ·±åº¦'] ?? 0}`,
          '',
          'æ¯’èˆŒç‚¹è¯„ï¼ˆMarkdownï¼‰ï¼š',
          app.eval.comment,
          '',
          'é«˜æ‰‹ç¤ºèŒƒï¼š',
          app.eval.example
        ].join('\\n');
        try {
          await navigator.clipboard.writeText(report);
          toast('success', 'å·²å¤åˆ¶', 'å®Œæ•´æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚');
        } catch (_) {
          toast('error', 'å¤åˆ¶å¤±è´¥', 'æµè§ˆå™¨æƒé™é™åˆ¶ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
        }
      });
      $('saveBtn').addEventListener('click', () => {
        if (!app.eval) return;
        const h = readHistory();
        const item = {
          created_at: new Date().toISOString(),
          day: todayKey(),
          topic: app.topic,
          strategy: app.strategy,
          tags: ['AIæµ‹è¯„', 'é€»è¾‘æ¼”æ­¦åœº'],
          total_score: app.eval.total_score,
          scores: app.eval.scores,
          comment_md: app.eval.comment,
          example_md: app.eval.example,
          answer: app.answer,
          duration_sec: app.practiceDurationSec || 0
        };
        h.unshift(item);
        writeHistory(h);
        toast('success', 'å·²ä¿å­˜', 'æŠ¥å‘Šå·²ä¿å­˜åˆ°å†å²ï¼Œå¹¶æ›´æ–°ç»Ÿè®¡ã€‚');
        renderStats();
        setRoute('home');
        resetTraining();
      });
      $('againBtn').addEventListener('click', () => {
        toast('info', 'å†æ¥ä¸€é¢˜', 'é‡ç½®è®­ç»ƒæµï¼Œç»§ç»­å†²åˆ†ã€‚');
        resetTraining();
        setStep(1);
      });

      // initial render
      syncKeyUI();
      renderStats();
      setRoute('home');
    });
  </script>
</body>
</html>