<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>逻辑演武场 - AI 逻辑口才特训</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        .view-hidden {
            display: none;
        }
        .pulse-ring {
            animation: pulse-ring 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-ring {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-100 min-h-screen">
    <!-- 全局导航栏 -->
    <nav class="fixed top-0 left-0 right-0 bg-slate-900/95 backdrop-blur-sm border-b border-amber-500/20 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-amber-400 to-emerald-400 bg-clip-text text-transparent">
                        逻辑演武场
                    </h1>
                </div>
                <div class="flex space-x-4">
                    <button onclick="showView('home')" class="nav-btn px-4 py-2 rounded-lg hover:bg-slate-800 transition-colors">
                        首页
                    </button>
                    <button onclick="showView('history')" class="nav-btn px-4 py-2 rounded-lg hover:bg-slate-800 transition-colors">
                        历史记录
                    </button>
                    <button onclick="showView('settings')" class="nav-btn px-4 py-2 rounded-lg hover:bg-slate-800 transition-colors">
                        设置
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <main class="pt-16 pb-8">
        <!-- HomeView: 首页 -->
        <div id="home-view" class="view fade-in">
            <div class="max-w-4xl mx-auto px-4 py-12">
                <div class="text-center mb-12">
                    <h2 class="text-5xl font-bold mb-4 bg-gradient-to-r from-amber-400 to-emerald-400 bg-clip-text text-transparent">
                        逻辑口才特训
                    </h2>
                    <p class="text-gray-400 text-lg">提升你的逻辑思维与表达能力</p>
                </div>
                
                <div class="bg-slate-800/50 rounded-xl p-8 mb-8 border border-amber-500/20">
                    <h3 class="text-xl font-semibold mb-4 text-amber-400">今日统计</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-slate-900/50 rounded-lg p-4 border border-emerald-500/20">
                            <div class="text-3xl font-bold text-emerald-400" id="today-count">0</div>
                            <div class="text-gray-400 text-sm">今日练习次数</div>
                        </div>
                        <div class="bg-slate-900/50 rounded-lg p-4 border border-emerald-500/20">
                            <div class="text-3xl font-bold text-emerald-400" id="today-time">0</div>
                            <div class="text-gray-400 text-sm">今日练习时长(分钟)</div>
                        </div>
                        <div class="bg-slate-900/50 rounded-lg p-4 border border-emerald-500/20">
                            <div class="text-3xl font-bold text-emerald-400" id="avg-score">-</div>
                            <div class="text-gray-400 text-sm">平均得分</div>
                        </div>
                    </div>
                </div>

                <div class="text-center">
                    <button onclick="startTraining()" class="bg-gradient-to-r from-amber-500 to-emerald-500 hover:from-amber-600 hover:to-emerald-600 text-white font-bold py-6 px-12 rounded-xl text-xl transition-all transform hover:scale-105 shadow-lg shadow-amber-500/50">
                        开始训练
                    </button>
                </div>
            </div>
        </div>

        <!-- SettingsView: 设置 -->
        <div id="settings-view" class="view view-hidden">
            <div class="max-w-2xl mx-auto px-4 py-12">
                <h2 class="text-3xl font-bold mb-8 text-center text-amber-400">设置</h2>
                <div class="bg-slate-800/50 rounded-xl p-8 border border-amber-500/20">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            DeepSeek API Key
                        </label>
                        <input 
                            type="password" 
                            id="api-key-input" 
                            placeholder="请输入你的 DeepSeek API Key"
                            class="w-full bg-slate-900 border border-amber-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                        />
                        <p class="text-xs text-gray-400 mt-2">
                            你的 API Key 将安全存储在本地浏览器中
                        </p>
                    </div>
                    <button 
                        onclick="saveApiKey()" 
                        class="w-full bg-gradient-to-r from-amber-500 to-emerald-500 hover:from-amber-600 hover:to-emerald-600 text-white font-bold py-3 px-6 rounded-lg transition-all"
                    >
                        保存
                    </button>
                    <div id="settings-message" class="mt-4"></div>
                </div>
            </div>
        </div>

        <!-- HistoryView: 历史记录 -->
        <div id="history-view" class="view view-hidden">
            <div class="max-w-4xl mx-auto px-4 py-12">
                <h2 class="text-3xl font-bold mb-8 text-center text-amber-400">历史记录</h2>
                <div id="history-list" class="space-y-4">
                    <!-- 历史记录将通过 JavaScript 动态生成 -->
                </div>
            </div>
        </div>

        <!-- TrainingFlow: 训练流 -->
        <div id="training-view" class="view view-hidden">
            <div class="max-w-4xl mx-auto px-4 py-8">
                <!-- 进度条 -->
                <div class="mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex-1 flex items-center">
                            <div class="flex-1 h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div id="progress-bar" class="h-full bg-gradient-to-r from-amber-500 to-emerald-500 transition-all duration-300" style="width: 25%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span id="step-1-label" class="text-amber-400 font-semibold">Step 1: 选题</span>
                        <span id="step-2-label" class="text-gray-500">Step 2: 策略</span>
                        <span id="step-3-label" class="text-gray-500">Step 3: 演练</span>
                        <span id="step-4-label" class="text-gray-500">Step 4: 报告</span>
                    </div>
                </div>

                <!-- Step 1: 选题 -->
                <div id="step-1" class="training-step fade-in">
                    <div class="mb-4">
                        <button onclick="showView('home')" class="text-amber-400 hover:text-amber-300 flex items-center">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                            返回上一步
                        </button>
                    </div>
                    <div class="bg-slate-800/50 rounded-xl p-8 border border-amber-500/20">
                        <h3 class="text-2xl font-bold mb-6 text-amber-400">Step 1: 选择题目</h3>
                        <div class="mb-6">
                            <button onclick="randomTopic()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 px-6 rounded-lg mb-4 transition-colors">
                                随机抽题
                            </button>
                            <div id="random-topic-display" class="bg-slate-900/50 rounded-lg p-4 mb-4 border border-emerald-500/20 min-h-[60px] flex items-center">
                                <span class="text-gray-400">点击上方按钮随机抽取题目</span>
                            </div>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                或自定义题目
                            </label>
                            <input 
                                type="text" 
                                id="custom-topic-input" 
                                placeholder="输入你的自定义题目..."
                                class="w-full bg-slate-900 border border-amber-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                            />
                        </div>
                        <button 
                            onclick="goToStep2()" 
                            class="w-full bg-gradient-to-r from-amber-500 to-emerald-500 hover:from-amber-600 hover:to-emerald-600 text-white font-bold py-3 px-6 rounded-lg transition-all"
                        >
                            下一步
                        </button>
                    </div>
                </div>

                <!-- Step 2: 策略生成 -->
                <div id="step-2" class="training-step view-hidden">
                    <div class="mb-4">
                        <button onclick="goToStep1()" class="text-amber-400 hover:text-amber-300 flex items-center">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                            返回上一步
                        </button>
                    </div>
                    <div class="bg-slate-800/50 rounded-xl p-8 border border-amber-500/20">
                        <h3 class="text-2xl font-bold mb-6 text-amber-400">Step 2: 选择策略</h3>
                        <div id="strategy-loading" class="text-center py-12">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-amber-500"></div>
                            <p class="mt-4 text-gray-400">正在生成策略...</p>
                        </div>
                        <div id="strategy-cards" class="hidden space-y-4">
                            <!-- 策略卡片将通过 JavaScript 动态生成 -->
                        </div>
                        <div id="strategy-error" class="hidden bg-red-900/30 border border-red-500/50 rounded-lg p-4 text-red-300">
                            <p id="strategy-error-text"></p>
                            <button onclick="generateStrategies()" class="mt-2 text-red-300 hover:text-red-200 underline">重试</button>
                        </div>
                        <button 
                            id="step2-next-btn"
                            onclick="goToStep3()" 
                            class="hidden w-full mt-6 bg-gradient-to-r from-amber-500 to-emerald-500 hover:from-amber-600 hover:to-emerald-600 text-white font-bold py-3 px-6 rounded-lg transition-all"
                        >
                            下一步
                        </button>
                    </div>
                </div>

                <!-- Step 3: 语音演练 -->
                <div id="step-3" class="training-step view-hidden">
                    <div class="mb-4">
                        <button onclick="goToStep2FromStep3()" class="text-amber-400 hover:text-amber-300 flex items-center">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                            返回上一步
                        </button>
                    </div>
                    <div class="bg-slate-800/50 rounded-xl p-8 border border-amber-500/20">
                        <h3 class="text-2xl font-bold mb-6 text-amber-400">Step 3: 语音演练</h3>
                        <div class="mb-6 bg-slate-900/50 rounded-lg p-4 border border-emerald-500/20">
                            <p class="text-sm text-gray-400 mb-2">当前题目：</p>
                            <p class="text-lg font-semibold text-emerald-400" id="step3-topic"></p>
                            <p class="text-sm text-gray-400 mt-3 mb-2">已选策略：</p>
                            <p class="text-emerald-300" id="step3-strategy"></p>
                        </div>
                        <div class="text-center mb-6">
                            <button 
                                id="record-btn"
                                onclick="toggleRecording()" 
                                class="w-32 h-32 rounded-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold text-lg transition-all transform hover:scale-105 shadow-lg shadow-red-500/50 flex items-center justify-center mx-auto"
                            >
                                <span id="record-btn-text">开始录音</span>
                            </button>
                            <p id="recording-status" class="mt-4 text-gray-400"></p>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                识别文本：
                            </label>
                            <div id="recognized-text" class="bg-slate-900 border border-amber-500/30 rounded-lg px-4 py-4 min-h-[120px] text-gray-300">
                                录音文本将显示在这里...
                            </div>
                        </div>
                        <div class="flex space-x-4">
                            <button 
                                onclick="resetRecording()" 
                                class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
                            >
                                重新录制
                            </button>
                            <button 
                                id="submit-btn"
                                onclick="goToStep4()" 
                                class="flex-1 bg-gradient-to-r from-amber-500 to-emerald-500 hover:from-amber-600 hover:to-emerald-600 text-white font-bold py-3 px-6 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled
                            >
                                提交测评
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 4: 智能测评 -->
                <div id="step-4" class="training-step view-hidden">
                    <div class="mb-4">
                        <button onclick="goToStep3FromStep4()" class="text-amber-400 hover:text-amber-300 flex items-center">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                            返回上一步
                        </button>
                    </div>
                    <div class="bg-slate-800/50 rounded-xl p-8 border border-amber-500/20">
                        <h3 class="text-2xl font-bold mb-6 text-amber-400">Step 4: 智能测评</h3>
                        <div id="feedback-loading" class="text-center py-12">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-amber-500"></div>
                            <p class="mt-4 text-gray-400">正在生成测评报告...</p>
                        </div>
                        <div id="feedback-content" class="hidden">
                            <!-- 评分仪表盘 -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                <div class="bg-slate-900/50 rounded-lg p-4 border border-emerald-500/20 text-center">
                                    <div class="text-3xl font-bold text-emerald-400" id="score-logic">-</div>
                                    <div class="text-sm text-gray-400 mt-1">逻辑闭环</div>
                                    <div class="text-xs text-gray-500">(30分)</div>
                                </div>
                                <div class="bg-slate-900/50 rounded-lg p-4 border border-emerald-500/20 text-center">
                                    <div class="text-3xl font-bold text-emerald-400" id="score-strategy">-</div>
                                    <div class="text-sm text-gray-400 mt-1">策略执行度</div>
                                    <div class="text-xs text-gray-500">(30分)</div>
                                </div>
                                <div class="bg-slate-900/50 rounded-lg p-4 border border-emerald-500/20 text-center">
                                    <div class="text-3xl font-bold text-emerald-400" id="score-fluency">-</div>
                                    <div class="text-sm text-gray-400 mt-1">表达流畅度</div>
                                    <div class="text-xs text-gray-500">(20分)</div>
                                </div>
                                <div class="bg-slate-900/50 rounded-lg p-4 border border-emerald-500/20 text-center">
                                    <div class="text-3xl font-bold text-emerald-400" id="score-speed">-</div>
                                    <div class="text-sm text-gray-400 mt-1">反应速度</div>
                                    <div class="text-xs text-gray-500">(20分)</div>
                                </div>
                            </div>
                            <div class="bg-slate-900/50 rounded-lg p-4 border border-emerald-500/20 mb-6">
                                <h4 class="text-lg font-semibold text-amber-400 mb-3">详细点评</h4>
                                <div id="feedback-text" class="prose prose-invert max-w-none text-gray-300"></div>
                            </div>
                        </div>
                        <div id="feedback-error" class="hidden bg-red-900/30 border border-red-500/50 rounded-lg p-4 text-red-300">
                            <p id="feedback-error-text"></p>
                            <button onclick="generateFeedback()" class="mt-2 text-red-300 hover:text-red-200 underline">重试</button>
                        </div>
                        <div class="flex space-x-4 mt-6">
                            <button 
                                onclick="saveAndReturn()" 
                                class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
                            >
                                保存并返回首页
                            </button>
                            <button 
                                onclick="trainAgain()" 
                                class="flex-1 bg-gradient-to-r from-amber-500 to-emerald-500 hover:from-amber-600 hover:to-emerald-600 text-white font-bold py-3 px-6 rounded-lg transition-all"
                            >
                                再练一题
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // 全局状态
        const state = {
            currentView: 'home',
            currentStep: 1,
            currentTopic: '',
            selectedStrategy: '',
            recognizedText: '',
            trainingData: {
                topic: '',
                strategy: '',
                answer: '',
                scores: {},
                feedback: ''
            }
        };

        // 内置题库
        const topicBank = [
            "如何说服老板给你加薪？",
            "面试时如何回答'你为什么离开上一家公司'？",
            "如何拒绝同事的不合理请求？",
            "如何在会议上提出不同意见而不得罪人？",
            "如何向客户解释产品涨价？",
            "如何说服父母支持你的职业选择？",
            "如何在团队冲突中保持中立并化解矛盾？",
            "如何向投资人解释项目延期？",
            "如何说服客户接受你的方案而不是竞争对手的？",
            "如何在谈判中争取更好的条件？",
            "如何向领导汇报项目失败？",
            "如何说服团队成员接受你的想法？",
            "如何在公开场合反驳错误观点？",
            "如何向客户解释服务中断？",
            "如何说服朋友改变不良习惯？",
            "如何在辩论中维护自己的立场？",
            "如何向用户解释产品功能限制？",
            "如何说服合作伙伴接受你的合作条件？",
            "如何在冲突中表达自己的需求？",
            "如何向团队解释战略调整？"
        ];

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            showView('home');
            loadApiKey();
            updateTodayStats();
            loadHistory();
        });

        // 视图切换
        function showView(viewName) {
            // 隐藏所有视图
            document.querySelectorAll('.view').forEach(v => {
                v.classList.add('view-hidden');
                v.classList.remove('fade-in');
            });

            // 显示目标视图
            const targetView = document.getElementById(`${viewName}-view`);
            if (targetView) {
                targetView.classList.remove('view-hidden');
                targetView.classList.add('fade-in');
                state.currentView = viewName;
            }

            // 更新导航按钮状态
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-slate-800', 'text-amber-400');
            });

            // 页面切换时更新相关数据
            if (viewName === 'history') {
                loadHistory();
            } else if (viewName === 'home') {
                updateTodayStats();
            }
        }

        // 开始训练
        function startTraining() {
            state.currentStep = 1;
            state.currentTopic = '';
            state.selectedStrategy = '';
            state.recognizedText = '';
            state.trainingData = {
                topic: '',
                strategy: '',
                answer: '',
                scores: {},
                feedback: ''
            };
            showView('training');
            showStep(1);
            document.getElementById('custom-topic-input').value = '';
            document.getElementById('random-topic-display').innerHTML = '<span class="text-gray-400">点击上方按钮随机抽取题目</span>';
        }

        // 显示训练步骤
        function showStep(step) {
            state.currentStep = step;
            
            // 隐藏所有步骤
            document.querySelectorAll('.training-step').forEach(s => {
                s.classList.add('view-hidden');
            });

            // 显示当前步骤
            const stepElement = document.getElementById(`step-${step}`);
            if (stepElement) {
                stepElement.classList.remove('view-hidden');
                stepElement.classList.add('fade-in');
            }

            // 更新进度条
            const progress = (step / 4) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;

            // 更新步骤标签
            for (let i = 1; i <= 4; i++) {
                const label = document.getElementById(`step-${i}-label`);
                if (i < step) {
                    label.classList.add('text-emerald-400');
                    label.classList.remove('text-gray-500', 'text-amber-400');
                } else if (i === step) {
                    label.classList.add('text-amber-400');
                    label.classList.remove('text-gray-500', 'text-emerald-400');
                } else {
                    label.classList.add('text-gray-500');
                    label.classList.remove('text-amber-400', 'text-emerald-400');
                }
            }
        }

        // Step 1: 随机抽题
        function randomTopic() {
            const randomIndex = Math.floor(Math.random() * topicBank.length);
            const topic = topicBank[randomIndex];
            state.currentTopic = topic;
            document.getElementById('random-topic-display').innerHTML = `<span class="text-emerald-300 text-lg">${topic}</span>`;
            document.getElementById('custom-topic-input').value = '';
        }

        // Step 1 -> Step 2
        function goToStep2() {
            const customTopic = document.getElementById('custom-topic-input').value.trim();
            const topic = customTopic || state.currentTopic;

            if (!topic) {
                alert('请先选择一个题目或输入自定义题目');
                return;
            }

            // 检查 API Key
            const apiKey = localStorage.getItem('deepseek_key');
            if (!apiKey) {
                if (confirm('请先设置 DeepSeek API Key。是否前往设置页面？')) {
                    showView('settings');
                    return;
                }
                return;
            }

            state.currentTopic = topic;
            state.trainingData.topic = topic;
            showStep(2);
            generateStrategies();
        }

        // Step 2: 生成策略
        async function generateStrategies() {
            const apiKey = localStorage.getItem('deepseek_key');
            if (!apiKey) {
                showStrategyError('请先设置 API Key');
                return;
            }

            // 显示加载状态
            document.getElementById('strategy-loading').classList.remove('hidden');
            document.getElementById('strategy-cards').classList.add('hidden');
            document.getElementById('strategy-error').classList.add('hidden');
            document.getElementById('step2-next-btn').classList.add('hidden');

            const prompt = `你是一位逻辑口才训练专家。针对以下题目，请生成3个截然不同的逻辑切入点策略，每个策略应该：
1. 有明确的逻辑框架
2. 有独特的切入角度（如：情感共鸣、利益交换、降维打击、数据支撑、类比论证等）
3. 简洁有力，适合口语表达

题目：${state.currentTopic}

请以JSON格式返回，格式如下：
{
  "strategies": [
    {
      "name": "策略名称",
      "description": "策略描述（50字以内）",
      "approach": "具体执行方法（100字以内）"
    }
  ]
}`;

            try {
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            { role: 'user', content: prompt }
                        ],
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`API 请求失败: ${response.status}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // 解析 JSON（可能包含 markdown 代码块）
                let jsonStr = content.trim();
                if (jsonStr.includes('```')) {
                    jsonStr = jsonStr.match(/```(?:json)?\s*([\s\S]*?)\s*```/)?.[1] || jsonStr;
                }
                const strategiesData = JSON.parse(jsonStr);

                // 显示策略卡片
                displayStrategies(strategiesData.strategies);
            } catch (error) {
                console.error('生成策略失败:', error);
                showStrategyError(`生成策略失败: ${error.message}`);
            }
        }

        function displayStrategies(strategies) {
            document.getElementById('strategy-loading').classList.add('hidden');
            const cardsContainer = document.getElementById('strategy-cards');
            cardsContainer.classList.remove('hidden');
            cardsContainer.innerHTML = '';

            strategies.forEach((strategy, index) => {
                const card = document.createElement('div');
                card.className = 'bg-slate-900/50 rounded-lg p-6 border border-amber-500/30 cursor-pointer hover:border-emerald-500 transition-all strategy-card';
                card.dataset.index = index;
                card.onclick = () => selectStrategy(index, strategy);
                
                card.innerHTML = `
                    <h4 class="text-xl font-semibold text-amber-400 mb-2">${strategy.name}</h4>
                    <p class="text-gray-300 mb-3">${strategy.description}</p>
                    <p class="text-sm text-gray-400">${strategy.approach}</p>
                `;
                
                cardsContainer.appendChild(card);
            });
        }

        function selectStrategy(index, strategy) {
            // 移除所有选中状态
            document.querySelectorAll('.strategy-card').forEach(card => {
                card.classList.remove('border-emerald-500', 'bg-emerald-900/20');
                card.classList.add('border-amber-500/30');
            });

            // 选中当前卡片
            const selectedCard = document.querySelector(`.strategy-card[data-index="${index}"]`);
            if (selectedCard) {
                selectedCard.classList.add('border-emerald-500', 'bg-emerald-900/20');
                selectedCard.classList.remove('border-amber-500/30');
            }

            state.selectedStrategy = `${strategy.name}: ${strategy.description}`;
            state.trainingData.strategy = state.selectedStrategy;
            document.getElementById('step2-next-btn').classList.remove('hidden');
        }

        function showStrategyError(message) {
            document.getElementById('strategy-loading').classList.add('hidden');
            document.getElementById('strategy-cards').classList.add('hidden');
            document.getElementById('strategy-error').classList.remove('hidden');
            document.getElementById('strategy-error-text').textContent = message;
        }

        // Step 2 -> Step 1
        function goToStep1() {
            showStep(1);
        }

        // Step 2 -> Step 3
        function goToStep3() {
            if (!state.selectedStrategy) {
                alert('请先选择一个策略');
                return;
            }
            showStep(3);
            document.getElementById('step3-topic').textContent = state.currentTopic;
            document.getElementById('step3-strategy').textContent = state.selectedStrategy;
            document.getElementById('recognized-text').textContent = '录音文本将显示在这里...';
            state.recognizedText = '';
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('record-btn-text').textContent = '开始录音';
            document.getElementById('recording-status').textContent = '';
        }

        // Step 3: 语音识别
        let recognition = null;
        let isRecording = false;

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.continuous = true;
                recognition.interimResults = true;

                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = state.recognizedText;

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    state.recognizedText = finalTranscript;
                    document.getElementById('recognized-text').textContent = finalTranscript + interimTranscript;
                    
                    // 检查文本长度
                    if (finalTranscript.trim().length > 10) {
                        document.getElementById('submit-btn').disabled = false;
                    }
                };

                recognition.onerror = (event) => {
                    console.error('语音识别错误:', event.error);
                    document.getElementById('recording-status').textContent = `识别错误: ${event.error}`;
                    stopRecording();
                };

                recognition.onend = () => {
                    if (isRecording) {
                        // 如果还在录音状态，重新开始（实现连续识别）
                        try {
                            recognition.start();
                        } catch (e) {
                            console.error('重新开始识别失败:', e);
                            stopRecording();
                        }
                    }
                };
            } else {
                alert('您的浏览器不支持语音识别功能。请使用 Chrome 或 Edge 浏览器。');
            }
        }

        function toggleRecording() {
            if (!recognition) {
                initSpeechRecognition();
            }

            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (recognition) {
                try {
                    recognition.start();
                    isRecording = true;
                    document.getElementById('record-btn').classList.remove('from-red-500', 'to-red-600');
                    document.getElementById('record-btn').classList.add('from-red-600', 'to-red-700', 'pulse-ring');
                    document.getElementById('record-btn-text').textContent = '录音中...';
                    document.getElementById('recording-status').textContent = '正在录音，请说话...';
                } catch (e) {
                    console.error('开始录音失败:', e);
                }
            }
        }

        function stopRecording() {
            if (recognition && isRecording) {
                recognition.stop();
                isRecording = false;
                document.getElementById('record-btn').classList.remove('from-red-600', 'to-red-700', 'pulse-ring');
                document.getElementById('record-btn').classList.add('from-red-500', 'to-red-600');
                document.getElementById('record-btn-text').textContent = '开始录音';
                document.getElementById('recording-status').textContent = '录音已停止';
            }
        }

        function resetRecording() {
            stopRecording();
            state.recognizedText = '';
            document.getElementById('recognized-text').textContent = '录音文本将显示在这里...';
            document.getElementById('submit-btn').disabled = true;
        }

        // Step 3 -> Step 2 (返回)
        function goToStep2FromStep3() {
            stopRecording();
            showStep(2);
        }

        // Step 3 -> Step 4
        function goToStep4() {
            const text = state.recognizedText.trim();
            if (text.length < 10) {
                alert('录音文本太短，请至少录制10个字');
                return;
            }

            stopRecording();
            state.trainingData.answer = text;
            showStep(4);
            generateFeedback();
        }

        // Step 4: 生成反馈
        async function generateFeedback() {
            const apiKey = localStorage.getItem('deepseek_key');
            if (!apiKey) {
                showFeedbackError('请先设置 API Key');
                return;
            }

            // 显示加载状态
            document.getElementById('feedback-loading').classList.remove('hidden');
            document.getElementById('feedback-content').classList.add('hidden');
            document.getElementById('feedback-error').classList.add('hidden');

            const prompt = `你是一位专业的逻辑口才训练导师。请对以下练习进行多维度评分和详细点评。

题目：${state.trainingData.topic}
选择的策略：${state.trainingData.strategy}
学员回答：${state.trainingData.answer}

请从以下维度进行评分（满分100分）：
1. 逻辑闭环（30分）：论证是否完整，逻辑链条是否清晰
2. 策略执行度（30分）：是否有效运用了选择的策略
3. 表达流畅度（20分）：语言是否流畅自然
4. 反应速度（20分）：回答是否及时有效

请以JSON格式返回，格式如下：
{
  "scores": {
    "logic": 25,
    "strategy": 28,
    "fluency": 18,
    "speed": 17
  },
  "total": 88,
  "feedback": "详细点评内容（Markdown格式），包括：\n1. 优点分析\n2. 逻辑漏洞指出\n3. 优化建议\n4. 给出优化后的金句示例"
}`;

            try {
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            { role: 'user', content: prompt }
                        ],
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`API 请求失败: ${response.status}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // 解析 JSON
                let jsonStr = content.trim();
                if (jsonStr.includes('```')) {
                    jsonStr = jsonStr.match(/```(?:json)?\s*([\s\S]*?)\s*```/)?.[1] || jsonStr;
                }
                const feedbackData = JSON.parse(jsonStr);

                // 显示反馈
                displayFeedback(feedbackData);
            } catch (error) {
                console.error('生成反馈失败:', error);
                showFeedbackError(`生成反馈失败: ${error.message}`);
            }
        }

        function displayFeedback(feedbackData) {
            document.getElementById('feedback-loading').classList.add('hidden');
            document.getElementById('feedback-content').classList.remove('hidden');

            // 显示分数
            document.getElementById('score-logic').textContent = feedbackData.scores.logic || 0;
            document.getElementById('score-strategy').textContent = feedbackData.scores.strategy || 0;
            document.getElementById('score-fluency').textContent = feedbackData.scores.fluency || 0;
            document.getElementById('score-speed').textContent = feedbackData.scores.speed || 0;

            // 显示点评（Markdown 渲染）
            const feedbackText = document.getElementById('feedback-text');
            if (window.marked) {
                feedbackText.innerHTML = marked.parse(feedbackData.feedback || '');
            } else {
                feedbackText.textContent = feedbackData.feedback || '';
            }

            // 保存到训练数据
            state.trainingData.scores = feedbackData.scores;
            state.trainingData.feedback = feedbackData.feedback;
            state.trainingData.total = feedbackData.total || 0;
        }

        function showFeedbackError(message) {
            document.getElementById('feedback-loading').classList.add('hidden');
            document.getElementById('feedback-content').classList.add('hidden');
            document.getElementById('feedback-error').classList.remove('hidden');
            document.getElementById('feedback-error-text').textContent = message;
        }

        // Step 4 -> Step 3 (返回)
        function goToStep3FromStep4() {
            showStep(3);
        }

        // 保存并返回首页
        function saveAndReturn() {
            // 保存到历史记录
            const history = JSON.parse(localStorage.getItem('history_list') || '[]');
            const record = {
                id: Date.now(),
                timestamp: new Date().toLocaleString('zh-CN'),
                topic: state.trainingData.topic,
                strategy: state.trainingData.strategy,
                answer: state.trainingData.answer,
                scores: state.trainingData.scores,
                total: state.trainingData.total,
                feedback: state.trainingData.feedback
            };
            history.unshift(record);
            localStorage.setItem('history_list', JSON.stringify(history));

            // 更新今日统计
            updateTodayStats();

            // 返回首页
            showView('home');
        }

        // 再练一题
        function trainAgain() {
            // 先保存当前记录
            saveAndReturn();
            // 然后重新开始训练
            setTimeout(() => {
                startTraining();
            }, 100);
        }

        // API Key 管理
        function loadApiKey() {
            const apiKey = localStorage.getItem('deepseek_key');
            if (apiKey) {
                document.getElementById('api-key-input').value = apiKey;
            }
        }

        function saveApiKey() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            if (!apiKey) {
                showSettingsMessage('API Key 不能为空', 'error');
                return;
            }
            localStorage.setItem('deepseek_key', apiKey);
            showSettingsMessage('API Key 已保存', 'success');
        }

        function showSettingsMessage(message, type) {
            const messageDiv = document.getElementById('settings-message');
            messageDiv.className = `mt-4 p-4 rounded-lg ${
                type === 'error' ? 'bg-red-900/30 text-red-300 border border-red-500/50' : 'bg-emerald-900/30 text-emerald-300 border border-emerald-500/50'
            }`;
            messageDiv.textContent = message;
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 3000);
        }

        // 历史记录
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('history_list') || '[]');
            const historyList = document.getElementById('history-list');
            
            if (history.length === 0) {
                historyList.innerHTML = '<div class="text-center text-gray-400 py-12">暂无历史记录</div>';
                return;
            }

            historyList.innerHTML = history.map(record => `
                <div class="bg-slate-800/50 rounded-xl p-6 border border-amber-500/20">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-amber-400 mb-2">${record.topic}</h3>
                            <p class="text-sm text-gray-400">${record.timestamp}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-emerald-400">${record.total || 0}</div>
                            <div class="text-xs text-gray-400">总分</div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <p class="text-sm text-gray-300 mb-1"><span class="text-gray-500">策略：</span>${record.strategy}</p>
                        <p class="text-sm text-gray-300"><span class="text-gray-500">回答：</span>${record.answer.substring(0, 100)}${record.answer.length > 100 ? '...' : ''}</p>
                    </div>
                    <button 
                        onclick="toggleHistoryDetail(${record.id})" 
                        class="text-amber-400 hover:text-amber-300 text-sm"
                    >
                        查看详情
                    </button>
                    <div id="detail-${record.id}" class="hidden mt-4 pt-4 border-t border-slate-700">
                        <div class="grid grid-cols-4 gap-4 mb-4">
                            <div class="text-center">
                                <div class="text-lg font-semibold text-emerald-400">${record.scores?.logic || 0}</div>
                                <div class="text-xs text-gray-400">逻辑闭环</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-semibold text-emerald-400">${record.scores?.strategy || 0}</div>
                                <div class="text-xs text-gray-400">策略执行</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-semibold text-emerald-400">${record.scores?.fluency || 0}</div>
                                <div class="text-xs text-gray-400">表达流畅</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-semibold text-emerald-400">${record.scores?.speed || 0}</div>
                                <div class="text-xs text-gray-400">反应速度</div>
                            </div>
                        </div>
                        <div class="bg-slate-900/50 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-amber-400 mb-2">详细点评</h4>
                            <div class="text-sm text-gray-300 prose prose-invert max-w-none">${window.marked ? marked.parse(record.feedback || '') : record.feedback || ''}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleHistoryDetail(id) {
            const detail = document.getElementById(`detail-${id}`);
            if (detail) {
                detail.classList.toggle('hidden');
            }
        }

        // 更新今日统计
        function updateTodayStats() {
            const history = JSON.parse(localStorage.getItem('history_list') || '[]');
            const today = new Date().toLocaleDateString('zh-CN');
            
            const todayRecords = history.filter(record => {
                const recordDate = new Date(record.timestamp).toLocaleDateString('zh-CN');
                return recordDate === today;
            });

            document.getElementById('today-count').textContent = todayRecords.length;
            
            // 计算平均分
            if (todayRecords.length > 0) {
                const totalScore = todayRecords.reduce((sum, r) => sum + (r.total || 0), 0);
                const avgScore = Math.round(totalScore / todayRecords.length);
                document.getElementById('avg-score').textContent = avgScore;
            } else {
                document.getElementById('avg-score').textContent = '-';
            }

            // 今日时长（简单估算，每次练习约5分钟）
            document.getElementById('today-time').textContent = todayRecords.length * 5;
        }

    </script>
</body>
</html>